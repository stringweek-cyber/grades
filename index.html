<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¤‘í•™êµ ì„±ì  ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5C6BC0;
            --highlight: #0000f2;
            --pen-color: #7986cb;
            --bg: #F0F2F5;
            --white: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --border: #e0e0e0;
            --danger: #ef5350;
            --success-bg: #e8f5e9;
            --success-text: #2e7d32;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* ìˆ«ì ì…ë ¥ì¹¸ í™”ì‚´í‘œ ì œê±° */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* í—¤ë” */
        header {
            background-color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .icon-btn { font-size: 24px; cursor: pointer; background: none; border: none; padding: 5px; }

        /* ì‚¬ì´ë“œë°” & ì˜¤ë²„ë ˆì´ */
        #sidebar {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: white; z-index: 2000; transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header {
            padding: 20px; background: var(--primary); color: white;
            font-size: 18px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .sidebar-menu li {
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; font-size: 15px; transition: background 0.2s;
        }
        .sidebar-menu li:hover { background: #f9f9f9; }
        .sidebar-menu li.active { background: #e8eaf6; color: var(--primary); font-weight: bold; border-left: 5px solid var(--primary); }
        
        .trend-menu-item {
            background: #fff8e1 !important; color: #f57f17 !important; font-weight: bold;
            border-top: 2px solid #eee;
        }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1500; display: none;
        }
        #overlay.show { display: block; }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* ë·° ì „í™˜ìš© */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ì°¨íŠ¸ ì¹´ë“œ */
        .chart-card {
            background: var(--white); border-radius: 15px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); text-align: center;
        }
        .chart-wrapper { position: relative; height: 220px; width: 100%; }
        
        .trend-title-area {
            text-align: left; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        .trend-title-area h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .trend-title-area p { margin: 5px 0 0 0; font-size: 12px; color: #666; }

        .chart-average {
            margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee;
            font-size: 14px; font-weight: bold; color: var(--primary);
        }

        /* ê³¼ëª© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .subject-card {
            background: var(--white); border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); overflow: hidden; border: 1px solid white;
        }
        .card-header {
            padding: 18px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; background: var(--white);
        }
        .subject-info { display: flex; align-items: center; gap: 8px; }
        .subject-info h3 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
        
        .edit-pen-btn { 
            cursor: pointer; padding: 5px; border: 1px solid #dae0f2;
            border-radius: 50%; background: #fff; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center;
            color: var(--pen-color); transition: all 0.2s;
        }
        .edit-pen-btn:hover { background-color: #f0f4ff; border-color: var(--pen-color); }
        .edit-pen-btn svg { pointer-events: none; }
        
        .score-badge {
            background: #E8EAF6; color: var(--primary); padding: 6px 12px;
            border-radius: 20px; font-weight: 700; font-size: 15px;
        }

        .card-body { display: none; background: #fff; padding: 0; border-top: 1px solid #eee; }
        .card-body.active { display: block; }

        .perf-item { padding: 15px 18px; border-bottom: 1px solid #f0f0f0; }
        .perf-row-main { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        
        .perf-left { display: block; flex: 1; min-width: 0; margin-right: 8px; }
        .perf-title-text { font-size: 15px; font-weight: 600; color: #333; display: inline; line-height: 1.4; word-break: keep-all; }
        .written-exam-text { color: var(--highlight) !important; }

        .perf-ratio-badge {
            font-size: 11px; background: #f1f2f6; color: #666; padding: 2px 6px;
            border-radius: 4px; white-space: nowrap; display: inline-block; vertical-align: middle; margin-left: 4px; margin-bottom: 2px;
        }
        
        .perf-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        
        /* ì ìˆ˜ ì…ë ¥ì¹¸ ìŠ¤íƒ€ì¼ */
        .score-input {
            width: 55px; padding: 6px; border: 1px solid #ddd; border-radius: 6px;
            text-align: center; font-size: 16px; font-weight: bold; outline: none;
        }
        .score-input:focus { border-color: var(--primary); }
        .unit-text { font-size: 14px; color: #333; font-weight: 500; }
        
        .memo-input {
            width: 100%; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px;
            font-size: 12px; resize: none; outline: none; color: #555; overflow-y: hidden; min-height: 40px; line-height: 1.4;
        }
        .memo-input:focus { background: #fff; border-color: #ddd; }

        .final-row { background: #eef2ff; padding: 15px 18px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #c5cae9; }
        .final-label { font-size: 16px; font-weight: 700; color: #333; }
        .final-score { font-size: 20px; font-weight: 800; color: var(--primary); }
        .final-feedback-area { padding: 0 18px 18px 18px; background: #eef2ff; }
        .final-feedback-input { width: 100%; padding: 10px; border: 1px solid #c5cae9; background: white; border-radius: 6px; font-size: 13px; resize: none; overflow-y: hidden; min-height: 50px; }

        /* ëª¨ë‹¬ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; }
        .modal { background: white; width: 90%; max-width: 400px; border-radius: 15px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .edit-item-row { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        
        .move-btn-group { display: flex; flex-direction: column; gap: 2px; margin-right: 5px; }
        .btn-move-row { background: none; border: 1px solid #eee; cursor: pointer; color: #bbb; padding: 0; width: 20px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
        .btn-move-row:hover { background-color: #f0f0f0; color: #666; border-color: #ccc; }
        
        .edit-input-name { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* ë¹„ìœ¨ ì…ë ¥ì¹¸ ìŠ¤íƒ€ì¼ */
        .edit-input-ratio { 
            width: 55px; flex: none; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; 
        }
        
        .btn-delete-row { background: none; border: none; cursor: pointer; color: #bbb; padding: 8px; margin-left: 2px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .btn-delete-row:hover { color: var(--danger); background-color: #ffebee; transform: scale(1.1); }
        .btn-delete-row svg { pointer-events: none; }
        
        /* ìˆ˜ì • ëª¨ë‹¬ ë²„íŠ¼ ê·¸ë£¹ */
        .edit-modal-btn-group { display: flex; gap: 8px; margin-top: 20px; }
        .edit-modal-btn-group button { flex: 1; padding: 8px 0; font-size: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; margin: 0; }
        .btn-add-item { background-color: var(--success-bg); color: var(--success-text); border: 1px dashed #a5d6a7; transition: background 0.2s; }
        .btn-add-item:hover { background-color: #c8e6c9; }
        .btn-save-edit { background: var(--primary); color: white; border: none; }
        .btn-cancel-edit { background: #f5f5f5; color: #777; border: 1px solid #ddd; }
        
        .modal h3 { margin-top: 0; color: var(--primary); }
        .modal-desc { font-size: 13px; color: #555; margin-bottom: 15px; line-height: 1.6; word-break: keep-all; text-align: center; }
        
        /* ì„¤ì • ëª¨ë‹¬ ë²„íŠ¼ */
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; flex: 1; }
        .btn-copy { width: 100%; background: #f0f0f0; color: #555; border: 1px solid #ddd; padding: 12px; border-radius: 8px; font-size: 14px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; transition: all 0.2s ease; }
        .btn-copy:hover { background: #e0e0e0; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-copy:active { transform: translateY(0); box-shadow: none; background: #dcdcdc; }
        .btn-close { background: #f5f5f5; color: #777; border: 1px solid #ddd; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; flex: 1; }
        .btn-close:hover { background: #e0e0e0; }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        
        .toast-message { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(40, 44, 52, 0.9); color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 2000; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none; }
        .toast-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .empty-state { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }

        /* ê¸°ë³¸ í•™ê¸° ì„¤ì • ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .default-semester-area {
            margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .default-semester-area label { font-weight: bold; font-size: 14px; color: #333; }
        .default-semester-area select {
            padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px;
        }
    </style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” ë©”ë‰´ -->
<div id="overlay" onclick="closeSidebar()"></div>
<nav id="sidebar">
    <div class="sidebar-header">
        <span>ğŸ“ í•™ë…„ í•™ê¸° ì„ íƒ</span>
        <span onclick="closeSidebar()" style="cursor:pointer; font-size:24px;">&times;</span>
    </div>
    <ul class="sidebar-menu">
        <li onclick="changeSemester('grade_1_1')" id="menu_grade_1_1">1í•™ë…„ 1í•™ê¸°</li>
        <li onclick="changeSemester('grade_1_2')" id="menu_grade_1_2">1í•™ë…„ 2í•™ê¸°</li>
        <li onclick="changeSemester('grade_2_1')" id="menu_grade_2_1">2í•™ë…„ 1í•™ê¸°</li>
        <li onclick="changeSemester('grade_2_2')" id="menu_grade_2_2">2í•™ë…„ 2í•™ê¸°</li>
        <li onclick="changeSemester('grade_3_1')" id="menu_grade_3_1">3í•™ë…„ 1í•™ê¸°</li>
        <li onclick="changeSemester('grade_3_2')" id="menu_grade_3_2">3í•™ë…„ 2í•™ê¸°</li>
        <li onclick="showTrendView()" class="trend-menu-item">ğŸ“ˆ ê³¼ëª©ë³„ ë³€í™”ë³´ê¸°</li>
    </ul>
</nav>

<header>
    <button class="icon-btn" onclick="openSidebar()">â˜°</button>
    <div class="header-title" id="pageTitle">2í•™ë…„ 2í•™ê¸° ì„±ì ê´€ë¦¬</div>
    <button class="icon-btn" id="settingBtn" onclick="openGlobalSettings()">âš™ï¸</button>
</header>

<div class="container">
    <!-- 1. ë©”ì¸ ì„±ì  ì…ë ¥ ë·° -->
    <div id="mainView" class="view-section active">
        <div class="chart-card">
            <div class="chart-wrapper">
                <canvas id="gradeChart"></canvas>
            </div>
            <div id="chartAverage" class="chart-average">ì „ì²´ í‰ê·  0ì </div>
        </div>
        <div id="subjectList"></div>
    </div>

    <!-- 2. ê³¼ëª©ë³„ ë³€í™” ê·¸ë˜í”„ ë·° -->
    <div id="trendView" class="view-section">
        <!-- ê·¸ë˜í”„ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingModal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ“‹ ì „ì²´ ê³¼ëª© í‰ê°€í•­ëª© ì„¤ì •</h3>
        
        <!-- ê¸°ë³¸ í•™ê¸° ì„¤ì • ì˜ì—­ -->
        <div class="default-semester-area">
            <label for="defaultSemesterSelect">ì²« í™”ë©´ í•™ê¸° ì„ íƒ:</label>
            <select id="defaultSemesterSelect">
                <option value="grade_1_1">1í•™ë…„ 1í•™ê¸°</option>
                <option value="grade_1_2">1í•™ë…„ 2í•™ê¸°</option>
                <option value="grade_2_1">2í•™ë…„ 1í•™ê¸°</option>
                <option value="grade_2_2">2í•™ë…„ 2í•™ê¸°</option>
                <option value="grade_3_1">3í•™ë…„ 1í•™ê¸°</option>
                <option value="grade_3_2">3í•™ë…„ 2í•™ê¸°</option>
            </select>
        </div>

        <p class="modal-desc">
            &lt;í‰ê°€ê³„íšì„œ ì‚¬ì§„&gt;ì„ ì œë¯¸ë‚˜ì´ì— ì˜¬ë¦¬ê³  í”„ë¡¬í”„íŠ¸ë¥¼ ë¶™ì—¬ ë„£ìœ¼ë©´ ì½”ë“œë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. ê·¸ ì½”ë“œë¥¼ ì•„ë˜ì— ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”.
        </p>
        <button class="btn-copy" onclick="copyPrompt(this)">
            ğŸ˜€ ì œë¯¸ë‚˜ì´ìš© í”„ë¡¬í”„íŠ¸ ë³µì‚¬í•˜ê¸°
        </button>
        <textarea id="jsonConfig" style="width:100%; height:105px; border:1px solid #ddd; border-radius:8px; padding:10px; background:#f8f9fa; font-family:monospace; resize:none;"></textarea>
        <div class="modal-btn-group">
            <button class="btn-save" onclick="saveGlobalConfig()">ì €ì¥ ë° ì ìš©</button>
            <button class="btn-close" onclick="closeModal('settingModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ê³¼ëª© ìˆ˜ì • ëª¨ë‹¬ -->
<div id="subjectEditModal" class="modal-overlay">
    <div class="modal">
        <h3 id="editModalTitle">ê³¼ëª© ìˆ˜ì •</h3>
        <p class="modal-desc">í•­ëª©ì„ ì¶”ê°€/ì‚­ì œí•˜ê±°ë‚˜ ì´ë¦„, ë¹„ìœ¨, ìˆœì„œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
        <div id="editItemsContainer"></div>
        <div class="edit-modal-btn-group">
            <button class="btn-add-item" onclick="addEditItemRow()">+ í•­ëª© ì¶”ê°€</button>
            <button class="btn-save-edit" onclick="saveSubjectChanges()">ìˆ˜ì • ì™„ë£Œ</button>
            <button class="btn-cancel-edit" onclick="closeModal('subjectEditModal')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    // --- 0. ì´ˆê¸° ë°ì´í„° ë° ì „ì—­ ë³€ìˆ˜ ---
    const defaultData_2_2 = [
      {"subject": "êµ­ì–´", "performances": [{"name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 27, "score": 0, "memo": ""}, {"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 27, "score": 0, "memo": ""}, {"name": "ë…ì„œê°ìƒë¬¸ì“°ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "í›ˆë¯¼ì •ìŒë¶„ë‹´ì§€ ì‘ì„±í•˜ê¸°", "ratio": 6, "score": 0, "memo": ""}, {"name": "ìƒˆë¡œìš´ê´€ì ìœ¼ë¡œ ì†Œì„¤ ë‹¤ì‹œì“°ê¸°", "ratio": 20, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ì—­ì‚¬", "performances": [{"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 50, "score": 0, "memo": ""}, {"name": "ì‚¬ë£Œë¹„íŒí•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}, {"name": "í”„ë‘ìŠ¤í˜ëª… íƒêµ¬í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì—­ì‚¬ì‹ ë¬¸ê¸°ì‚¬ë‰´ìŠ¤ ë§Œë“¤ê¸°", "ratio": 20, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ì‚¬íšŒ", "performances": [{"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 50, "score": 0, "memo": ""}, {"name": "ë¯¸ë˜ì‹ ë¬¸ì‘ì„±í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ê¸°í›„ë³€í™”íƒêµ¬í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì‚¬íšŒë°°ì›€ë…¸íŠ¸ ì‘ì„±í•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ë„ë•", "performances": [{"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 50, "score": 0, "memo": ""}, {"name": "ëŒ€ì¤‘ë§¤ì²´í™ë³´ë¬¼ ë§Œë“¤ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì‚¬íšŒì •ì˜íƒêµ¬í•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}, {"name": "í†µì¼ì‹ ë¬¸ì œì‘í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ìˆ˜í•™", "performances": [{"name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 25, "score": 0, "memo": ""}, {"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 25, "score": 0, "memo": ""}, {"name": "ë„í˜•ì˜ì„±ì§ˆë¬¸ì œ í•´ê²°í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ë„í˜•ì˜ë‹®ìŒë¬¸ì œ í•´ê²°í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ê²½ìš°ì˜ìˆ˜íƒêµ¬í•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ê³¼í•™", "performances": [{"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 50, "score": 0, "memo": ""}, {"name": "ì˜ì–‘ì†Œê²€ì¶œì‹¤í—˜ê³¼ ì†Œí™”íš¨ì†Œíƒêµ¬í•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}, {"name": "ìˆœí™˜ê³„ì˜êµ¬ì¡°ì™€ ê¸°ëŠ¥ë…¼ìˆ í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ê³ ì²´ì˜ ìš©í•´ë„ ë¶„ì„í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ì²´ìœ¡", "performances": [{"name": "ìŠ¤í¬ì¸ ì•ˆì „ì‚¬ê³  ì˜ˆë°©í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì¤„ë„˜ê¸°í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì¶•êµ¬íŒ¨ìŠ¤í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì¶•êµ¬ìŠˆíŒ…í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì¶•êµ¬ë¦¬í”„íŒ…í•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ìŒì•…", "performances": [{"name": "ì¥êµ¬ì—°ì£¼í•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}, {"name": "êµ­ì•…ì†Œê°œí•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}, {"name": "êµ­ì•…ì´ë¡ ë…¼ìˆ í•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}, {"name": "êµ­ì•…ì‚¬í‘œí˜„í•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ë¯¸ìˆ ", "performances": [{"name": "ë¯¸ìˆ ê°ìƒë…¼ìˆ  ì‘ì„±í•˜ê¸°", "ratio": 30, "score": 0, "memo": ""}, {"name": "ë¯¸ìˆ ì „ì‹œê¸°íš ì•„ì´ë””ì–´ ìŠ¤ì¼€ì¹˜í•˜ê¸°", "ratio": 15, "score": 0, "memo": ""}, {"name": "ë¯¸ìˆ ì „ì‹œê¸°íší•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ëª…í™”íŒ¨ëŸ¬ë”” ì•„ì´ë””ì–´ ìŠ¤ì¼€ì¹˜í•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}, {"name": "ëª…í™”íŒ¨ëŸ¬ë””í•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "ì˜ì–´", "performances": [{"name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 25, "score": 0, "memo": ""}, {"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 25, "score": 0, "memo": ""}, {"name": "ê°ì‚¬ì™€ì‚¬ê³¼í•˜ëŠ” ì‚¬ì—°ì“°ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ì‚¬ì—°ë°œí‘œí•˜ê¸°", "ratio": 20, "score": 0, "memo": ""}, {"name": "ë¬¸í™”ë¹„êµí¬íŠ¸í´ë¦¬ì˜¤ ì‘ì„±í•˜ê¸°", "ratio": 10, "score": 0, "memo": ""}], "finalFeedback": ""},
      {"subject": "í•œë¬¸", "performances": [{"name": "ë‚˜ë§Œì˜í•œìì–´ì‚¬ì „ ë§Œë“¤ê¸°", "ratio": 25, "score": 0, "memo": ""}, {"name": "ì‘í˜¸ì„¤ëª…ì„œì“°ê¸°", "ratio": 25, "score": 0, "memo": ""}, {"name": "ê³ ì‚¬ì„±ì–´ ì¬í•´ì„í•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}, {"name": "í•œìì“°ê¸° í¬íŠ¸í´ë¦¬ì˜¤ ì‘ì„±í•˜ê¸°", "ratio": 25, "score": 0, "memo": ""}], "finalFeedback": ""}
    ];

    const emptyTemplate = [
        { subject: "êµ­ì–´", performances: [{"name":"1ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"2ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"ìˆ˜í–‰í‰ê°€", ratio:40, score:0}], finalFeedback:"" },
        { subject: "ìˆ˜í•™", performances: [{"name":"1ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"2ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"ìˆ˜í–‰í‰ê°€", ratio:40, score:0}], finalFeedback:"" },
        { subject: "ì˜ì–´", performances: [{"name":"1ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"2ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"ìˆ˜í–‰í‰ê°€", ratio:40, score:0}], finalFeedback:"" }
    ];

    let currentSemesterId = 'grade_2_2'; 
    let subjects = []; 
    let myChart = null;
    let trendCharts = [];
    let currentEditIndex = -1;

    window.onload = function() {
        migrateOldData();
        
        // ê¸°ë³¸ í•™ê¸° ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedDefault = localStorage.getItem('defaultSemesterId');
        currentSemesterId = savedDefault || 'grade_2_2'; 
        
        loadData(currentSemesterId);
        renderSubjects();
        renderChart();
        updateSidebarActiveState();
    };

    function updateSidebarActiveState() {
        document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
        const targetMenu = document.getElementById('menu_' + currentSemesterId);
        if(targetMenu) targetMenu.classList.add('active');
    }

    function migrateOldData() {
        const oldData = localStorage.getItem('gradeAppData_v23');
        const newData = localStorage.getItem('grade_2_2');
        if (oldData && !newData) {
            localStorage.setItem('grade_2_2', oldData);
        }
    }

    function loadData(id) {
        currentSemesterId = id;
        const saved = localStorage.getItem(id);
        
        if (saved) {
            subjects = JSON.parse(saved);
        } else {
            if (id === 'grade_2_2') {
                subjects = JSON.parse(JSON.stringify(defaultData_2_2));
                localStorage.setItem(id, JSON.stringify(subjects));
            } else {
                subjects = JSON.parse(JSON.stringify(emptyTemplate));
            }
        }
        updatePageTitle();
    }

    function saveData() {
        localStorage.setItem(currentSemesterId, JSON.stringify(subjects));
    }

    function openSidebar() {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('overlay').classList.add('show');
    }
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('show');
    }

    function changeSemester(id) {
        currentSemesterId = id;
        updateSidebarActiveState();
        document.getElementById('mainView').classList.add('active');
        document.getElementById('trendView').classList.remove('active');
        document.getElementById('settingBtn').style.display = 'block';
        loadData(id);
        renderSubjects();
        renderChart();
        closeSidebar();
    }

    function updatePageTitle() {
        const map = {
            'grade_1_1': '1í•™ë…„ 1í•™ê¸°', 'grade_1_2': '1í•™ë…„ 2í•™ê¸°',
            'grade_2_1': '2í•™ë…„ 1í•™ê¸°', 'grade_2_2': '2í•™ë…„ 2í•™ê¸°',
            'grade_3_1': '3í•™ë…„ 1í•™ê¸°', 'grade_3_2': '3í•™ë…„ 2í•™ê¸°'
        };
        document.getElementById('pageTitle').innerText = map[currentSemesterId] + " ì„±ì ê´€ë¦¬";
    }

    // --- 3. ê³¼ëª©ë³„ ë³€í™” (Trend) ê¸°ëŠ¥ ---
    function showTrendView() {
        document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
        document.getElementById('mainView').classList.remove('active');
        document.getElementById('trendView').classList.add('active');
        document.getElementById('pageTitle').innerText = "ê³¼ëª©ë³„ ì§€í•„í‰ê°€ ë³€í™”";
        document.getElementById('settingBtn').style.display = 'none'; 
        closeSidebar();
        renderAllTrendCharts();
    }

    function renderAllTrendCharts() {
        const trendContainer = document.getElementById('trendView');
        trendContainer.innerHTML = ''; 
        
        trendCharts.forEach(chart => chart.destroy());
        trendCharts = [];

        const semesters = ['grade_1_1', 'grade_1_2', 'grade_2_1', 'grade_2_2', 'grade_3_1', 'grade_3_2'];
        const labels = ['1-1 1ì°¨', '1-1 2ì°¨', '1-2 1ì°¨', '1-2 2ì°¨', '2-1 1ì°¨', '2-1 2ì°¨', '2-2 1ì°¨', '2-2 2ì°¨', '3-1 1ì°¨', '3-1 2ì°¨', '3-2 1ì°¨', '3-2 2ì°¨'];

        let allSubjects = new Set();
        const defaultRaw = localStorage.getItem('grade_2_2');
        if(defaultRaw) {
            JSON.parse(defaultRaw).forEach(s => allSubjects.add(s.subject));
        }

        semesters.forEach(sem => {
            const raw = localStorage.getItem(sem);
            if(raw) {
                JSON.parse(raw).forEach(s => allSubjects.add(s.subject));
            }
        });
        
        const subjectsList = Array.from(allSubjects);

        if (subjectsList.length === 0) {
            trendContainer.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê° í•™ê¸°ë³„ë¡œ ê³¼ëª©ê³¼ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
            return;
        }

        subjectsList.forEach((subjectName, idx) => {
            const scores = [];
            let hasData = false;

            semesters.forEach(sem => {
                const raw = localStorage.getItem(sem);
                let s1 = null, s2 = null;

                if(raw) {
                    const data = JSON.parse(raw);
                    const subj = data.find(s => s.subject === subjectName);
                    if(subj) {
                        const exam1 = subj.performances.find(p => p.name.includes("1ì°¨") && checkIsWrittenExam(p.name));
                        const exam2 = subj.performances.find(p => p.name.includes("2ì°¨") && checkIsWrittenExam(p.name));
                        
                        if(exam1 && exam1.score > 0) { s1 = exam1.score; hasData = true; }
                        if(exam2 && exam2.score > 0) { s2 = exam2.score; hasData = true; }
                    }
                }
                scores.push(s1);
                scores.push(s2);
            });

            const card = document.createElement('div');
            card.className = 'chart-card';
            card.innerHTML = `
                <div class="trend-title-area">
                    <h3>${subjectName}</h3>
                    <p>ì§€í•„í‰ê°€ ì ìˆ˜ ë³€í™”</p>
                </div>
                <div class="chart-wrapper" style="height: 200px;">
                    <canvas id="trendChart_${idx}"></canvas>
                </div>
            `;
            trendContainer.appendChild(card);

            const ctx = document.getElementById(`trendChart_${idx}`).getContext('2d');
            const color = getColor(idx);

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì ìˆ˜',
                        data: scores,
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        fill: false,
                        tension: 0.2,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false, 
                            min: 50, 
                            max: 100,
                            grid: { borderDash: [2, 4] }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: function(context) { return context.raw ? context.raw + 'ì ' : ''; } } }
                    }
                }
            });
            trendCharts.push(chart);
        });
    }

    function getColor(idx) {
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        return colors[idx % colors.length];
    }

    // --- ë©”ì¸ ë¡œì§ ---
    function checkIsWrittenExam(name) {
        return name.includes("ì§€í•„") || (name.includes("ê³ ì‚¬") && !name.includes("ê³ ì‚¬ì„±ì–´"));
    }

    function calculateTotal(sub) {
        return sub.performances.reduce((acc, curr) => {
            if (checkIsWrittenExam(curr.name)) {
                return acc + (curr.score * (curr.ratio / 100));
            } else {
                return acc + curr.score;
            }
        }, 0);
    }

    function getGrade(score) {
        if (score === 0) return '';
        const rounded = Math.round(score);
        if (rounded >= 90) return 'A';
        if (rounded >= 80) return 'B';
        if (rounded >= 70) return 'C';
        if (rounded >= 60) return 'D';
        return 'E';
    }

    function getGradeText(score, subjectName) {
        const grade = getGrade(score);
        if (!grade) return '';
        if (subjectName === 'ì—­ì‚¬' && grade === 'A') {
            return ` (<span style="color: #0000f2; font-weight: 900;">${grade}</span>)`;
        }
        return ` (${grade})`;
    }

    function autoResize(textarea) {
        textarea.style.height = '1px';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function renderSubjects() {
        const list = document.getElementById('subjectList');
        list.innerHTML = '';
        subjects.forEach((sub, subIdx) => {
            let totalScore = calculateTotal(sub);
            let roundedScore = Math.round(totalScore);
            let gradeText = getGradeText(totalScore, sub.subject);
            const perfCount = sub.performances.filter(p => !checkIsWrittenExam(p.name)).length;
            const card = document.createElement('div');
            card.className = 'subject-card';
            let html = `
                <div class="card-header" onclick="toggleCard(event, this)">
                    <div class="subject-info">
                        <h3>${sub.subject}</h3>
                        <div class="edit-pen-btn" onclick="openSubjectEditModal(event, ${subIdx})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </div>
                    </div>
                    <div class="score-badge">${roundedScore}ì ${gradeText}</div>
                </div>
                <span style="display:block; padding:0 18px; margin-top:-10px; margin-bottom:10px; font-size:12px; color:#666;">ìˆ˜í–‰í‰ê°€ í•­ëª© (${perfCount}ê°œ)</span>
                <div class="card-body">
            `;
            sub.performances.forEach((perf, perfIdx) => {
                const isWrittenExam = checkIsWrittenExam(perf.name);
                const titleClass = isWrittenExam ? "perf-title-text written-exam-text" : "perf-title-text";
                html += `
                    <div class="perf-item">
                        <div class="perf-row-main">
                            <div class="perf-left"><span class="${titleClass}">${perf.name}</span><span class="perf-ratio-badge">ë¹„ìœ¨ ${perf.ratio}%</span></div>
                            <div class="perf-right">
                                <input type="number" class="score-input" placeholder="0" min="0" max="100" value="${perf.score > 0 ? perf.score : ''}" onchange="updateScore(${subIdx}, ${perfIdx}, this.value)">
                                <span class="unit-text">ì </span>
                            </div>
                        </div>
                        <textarea class="memo-input" rows="1" placeholder="ê°ì ì‚¬í•­ ê¸°ë¡" oninput="autoResize(this)" onchange="updateMemo(${subIdx}, ${perfIdx}, this.value)">${perf.memo || ''}</textarea>
                    </div>`;
            });
            html += `<div class="final-row"><span class="final-label">ìµœì¢… ì ìˆ˜</span><span class="final-score">${roundedScore}ì </span></div>
                     <div class="final-feedback-area"><textarea class="final-feedback-input" rows="2" placeholder="ì´í‰ì„ ì…ë ¥í•˜ì„¸ìš”." oninput="autoResize(this)" onchange="updateFinalFeedback(${subIdx}, this.value)">${sub.finalFeedback || ''}</textarea></div></div>`;
            card.innerHTML = html;
            list.appendChild(card);
        });
        setTimeout(() => { document.querySelectorAll('.memo-input, .final-feedback-input').forEach(el => autoResize(el)); }, 10);
    }

    function toggleCard(event, header) {
        if (event.target.closest('.edit-pen-btn')) return;
        const body = header.nextElementSibling.nextElementSibling;
        const allBodies = document.querySelectorAll('.card-body');
        const isActive = body.classList.contains('active');
        allBodies.forEach(b => { b.classList.remove('active'); });
        if (!isActive) { body.classList.add('active'); setTimeout(() => { body.querySelectorAll('textarea').forEach(el => autoResize(el)); }, 50); }
    }

    function updateScore(subIdx, perfIdx, val) {
        let score = parseFloat(val); if (isNaN(score)) score = 0; if (score > 100) score = 100; if (score < 0) score = 0;
        subjects[subIdx].performances[perfIdx].score = score;
        saveData(); renderSubjects(); updateChartData();
        setTimeout(() => { 
            const bodies = document.querySelectorAll('.card-body');
            if(bodies[subIdx]) { bodies[subIdx].classList.add('active'); bodies[subIdx].querySelectorAll('textarea').forEach(el => autoResize(el)); }
        }, 10);
    }
    
    function updateMemo(subIdx, perfIdx, val) { subjects[subIdx].performances[perfIdx].memo = val; saveData(); }
    function updateFinalFeedback(subIdx, val) { subjects[subIdx].finalFeedback = val; saveData(); }

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function openSubjectEditModal(event, subIdx) {
        event.stopPropagation(); currentEditIndex = subIdx;
        const subject = subjects[subIdx];
        document.getElementById('editModalTitle').innerText = `[${subject.subject}] ìˆ˜ì •`;
        const container = document.getElementById('editItemsContainer'); container.innerHTML = '';
        subject.performances.forEach((perf, idx) => { addEditRowToModal(perf.name, perf.ratio, idx); });
        document.getElementById('subjectEditModal').style.display = 'flex';
    }
    function addEditRowToModal(name = "", ratio = "", originalIndex = -1) {
        const container = document.getElementById('editItemsContainer');
        const row = document.createElement('div'); row.className = 'edit-item-row'; row.dataset.originalIndex = originalIndex;
        row.innerHTML = `
            <div class="move-btn-group"><button class="btn-move-row" onclick="moveRowUp(this)">â–²</button><button class="btn-move-row" onclick="moveRowDown(this)">â–¼</button></div>
            <input type="text" class="edit-input-name" value="${name}" placeholder="í•­ëª©ëª…">
            <input type="number" class="edit-input-ratio" value="${ratio}" placeholder="ë¹„ìœ¨"><span>%</span>
            <button class="btn-delete-row" type="button" onclick="removeEditItemRow(this)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
        container.appendChild(row);
    }
    function addEditItemRow() { addEditRowToModal(); const modal = document.querySelector('#subjectEditModal .modal'); setTimeout(() => modal.scrollTop = modal.scrollHeight, 10); }
    function moveRowUp(btn) { const row = btn.closest('.edit-item-row'); const prev = row.previousElementSibling; if (prev) row.parentNode.insertBefore(row, prev); }
    function moveRowDown(btn) { const row = btn.closest('.edit-item-row'); const next = row.nextElementSibling; if (next) row.parentNode.insertBefore(next, row); }
    function removeEditItemRow(btn) { btn.closest('.edit-item-row').remove(); }
    
    function saveSubjectChanges() {
        try {
            if (currentEditIndex === -1) return;
            const container = document.getElementById('editItemsContainer'); const rows = container.querySelectorAll('.edit-item-row');
            const newPerfs = [];
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const name = row.querySelector('.edit-input-name').value.trim();
                let ratio = parseFloat(row.querySelector('.edit-input-ratio').value); if (isNaN(ratio)) ratio = 0;
                const originalIndex = parseInt(row.dataset.originalIndex);
                let score = 0; let memo = "";
                if (originalIndex !== -1 && subjects[currentEditIndex].performances[originalIndex]) {
                    score = subjects[currentEditIndex].performances[originalIndex].score;
                    memo = subjects[currentEditIndex].performances[originalIndex].memo;
                }
                newPerfs.push({ name, ratio, score, memo });
            }
            subjects[currentEditIndex].performances = newPerfs; saveData();
            closeModal('subjectEditModal'); renderSubjects(); renderChart(); showToast("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (error) { showToast("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
    }

    function openGlobalSettings() { 
        document.getElementById('jsonConfig').value = JSON.stringify(subjects, null, 2); 
        
        // ì €ì¥ëœ ê¸°ë³¸ í•™ê¸°ê°’ ë¶ˆëŸ¬ì™€ì„œ ì„¸íŒ…
        const savedDefault = localStorage.getItem('defaultSemesterId') || 'grade_2_2';
        document.getElementById('defaultSemesterSelect').value = savedDefault;

        document.getElementById('settingModal').style.display = 'flex'; 
    }

    function saveGlobalConfig() {
        try {
            // 1. ë°ì´í„° ì €ì¥
            subjects = JSON.parse(document.getElementById('jsonConfig').value);
            
            // 2. ê¸°ë³¸ í•™ê¸° ì„¤ì • ì €ì¥
            const selectedDefault = document.getElementById('defaultSemesterSelect').value;
            localStorage.setItem('defaultSemesterId', selectedDefault);

            saveData(); 
            renderSubjects(); 
            renderChart(); 
            closeModal('settingModal'); 
            showToast("ì„¤ì •ì´ ì €ì¥ ë° ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { 
            showToast("JSON ì½”ë“œ ì˜¤ë¥˜ì…ë‹ˆë‹¤."); 
        }
    }

    function copyPrompt(btnElement) {
        const promptText = `ì´ ì´ë¯¸ì§€ì— ìˆëŠ” í‰ê°€ ê³„íší‘œë¥¼ ë¶„ì„í•´ì„œ ì•„ë˜ JSON í¬ë§·ì˜ ì½”ë“œë¡œ ë³€í™˜í•´ì¤˜.\nì˜¤ì§ JSON ì½”ë“œë§Œ ì¶œë ¥í•´.\n\n[ìš”êµ¬ì‚¬í•­]\n1. ê³¼ëª©ë³„ë¡œ ìˆ˜í–‰í‰ê°€ í•­ëª©ê³¼ ì§€í•„í‰ê°€(ì¤‘ê°„/ê¸°ë§ ë“±)ë¥¼ ëª¨ë‘ í¬í•¨í•  ê²ƒ.\n2. 'ì§€í•„í‰ê°€'ëŠ” ì´ë¦„ì— ë°˜ë“œì‹œ 'ì§€í•„í‰ê°€' ë˜ëŠ” 'ê³ ì‚¬'ë¼ëŠ” ë‹¨ì–´ë¥¼ í¬í•¨í•  ê²ƒ.\n3. ìˆ˜í–‰í‰ê°€ë‚˜ ì§€í•„í‰ê°€ì˜ ë¹„ìœ¨(%)ì€ ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ 'ratio'ì— ë„£ì„ ê²ƒ.\n4. JSON êµ¬ì¡°ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ë”°ë¥¼ ê²ƒ:\n\n[\n  {\n    "subject": "ê³¼ëª©ëª…",\n    "performances": [\n      {"name": "í‰ê°€í•­ëª©ëª…", "ratio": 20, "score": 0, "memo": ""},\n      {"name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0, "memo": ""}\n    ],\n    "finalFeedback": ""\n  }\n]`;
        const textArea = document.createElement("textarea"); textArea.value = promptText; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select();
        try { document.execCommand('copy'); 
            const originalText = btnElement.innerHTML;
            btnElement.innerHTML = "âœ… í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!";
            btnElement.style.backgroundColor = "#d4edda"; btnElement.style.color = "#155724"; btnElement.style.borderColor = "#c3e6cb";
            setTimeout(() => { btnElement.innerHTML = originalText; btnElement.style.backgroundColor = "#f0f0f0"; btnElement.style.color = "#555"; btnElement.style.borderColor = "#ddd"; }, 2000);
        } catch (err) { showToast("ë³µì‚¬ ì‹¤íŒ¨."); } finally { document.body.removeChild(textArea); }
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(message) {
        const toast = document.createElement('div'); toast.className = 'toast-message'; toast.innerText = message; document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 2000);
    }

    function renderChart() {
        const ctx = document.getElementById('gradeChart').getContext('2d');
        if (myChart) myChart.destroy();
        const labels = subjects.map(s => { const t = calculateTotal(s); const g = getGrade(t); return g ? `${s.subject}(${g})` : s.subject; });
        const data = subjects.map(s => Math.round(calculateTotal(s)));
        const sum = data.reduce((a, b) => a + b, 0);
        const avg = (sum / data.length) || 0;
        document.getElementById('chartAverage').innerText = `ì „ì²´ í‰ê·  ${Math.round(avg)}ì `;
        
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì ìˆ˜', data: data,
                    backgroundColor: data.map(score => { if(score >= 90) return 'rgba(92, 107, 192, 0.8)'; if(score >= 70) return 'rgba(38, 198, 218, 0.8)'; return 'rgba(255, 82, 82, 0.8)'; }),
                    borderRadius: 5, borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, min: 50, max: 100, grid: { borderDash: [2, 4] }, ticks: { stepSize: 10 } }, x: { grid: { display: false }, ticks: { font: { size: 11, weight: 'bold' } } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.raw + 'ì ' } } } }
        });
    }

    function updateChartData() {
        if (!myChart) { renderChart(); return; }
        const newData = subjects.map(s => Math.round(calculateTotal(s)));
        const newLabels = subjects.map(s => { const t = calculateTotal(s); const g = getGrade(t); return g ? `${s.subject}(${g})` : s.subject; });
        myChart.data.datasets[0].data = newData;
        myChart.data.datasets[0].backgroundColor = newData.map(score => { if(score >= 90) return 'rgba(92, 107, 192, 0.8)'; if(score >= 70) return 'rgba(38, 198, 218, 0.8)'; return 'rgba(255, 82, 82, 0.8)'; });
        myChart.data.labels = newLabels;
        const sum = newData.reduce((a, b) => a + b, 0);
        const avg = (sum / newData.length) || 0;
        document.getElementById('chartAverage').innerText = `ì „ì²´ í‰ê·  ${Math.round(avg)}ì `;
        myChart.update();
    }
</script>
</body>
</html>
