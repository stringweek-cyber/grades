<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¤‘í•™êµ ì„±ì  ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5C6BC0;
            --highlight: #0000f2;
            --pen-color: #7986cb;
            --target-color: #ef5350; /* ëª©í‘œ ë²„íŠ¼ ìƒ‰ìƒ */
            --bg: #F0F2F5;
            --white: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --border: #e0e0e0;
            --danger: #ef5350;
            --success-bg: #e8f5e9;
            --success-text: #2e7d32;
            
            /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ìˆ˜ */
            --text-perf: #5C6BC0; 
            --text-exam: #283593; 
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        header {
            background-color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .icon-btn { font-size: 24px; cursor: pointer; background: none; border: none; padding: 5px; }

        #sidebar {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: white; z-index: 2000; transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header {
            padding: 20px; background: var(--primary); color: white;
            font-size: 18px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .sidebar-menu li {
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; font-size: 15px; transition: background 0.2s;
        }
        .sidebar-menu li:hover { background: #f9f9f9; }
        .sidebar-menu li.active { background: #e8eaf6; color: var(--primary); font-weight: bold; border-left: 5px solid var(--primary); }
        
        .trend-menu-item {
            background: #fff8e1 !important; color: #f57f17 !important; font-weight: bold;
            border-top: 2px solid #eee;
        }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1500; display: none;
        }
        #overlay.show { display: block; }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .chart-card {
            background: var(--white); border-radius: 15px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); text-align: center;
        }
        .chart-wrapper { position: relative; height: 220px; width: 100%; }
        
        .trend-title-area {
            text-align: left; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        .trend-title-area h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .trend-title-area p { margin: 5px 0 0 0; font-size: 12px; color: #666; }

        .avg-dashboard {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }
        .avg-box {
            flex: 1;
            text-align: center;
            border-right: 1px solid #eee;
        }
        .avg-box:last-child { border-right: none; }
        .avg-label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; font-weight: 500; }
        .avg-value { font-size: 15px; font-weight: 800; color: #333; }
        .avg-value.main { color: var(--primary); font-size: 18px; }

        .subject-card {
            background: var(--white); border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); overflow: hidden; border: 1px solid white;
        }
        .card-header {
            padding: 18px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; background: var(--white);
        }
        .subject-info { display: flex; align-items: center; gap: 8px; }
        .subject-info h3 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
        
        .icon-action-btn { 
            cursor: pointer; padding: 5px; border: 1px solid #dae0f2;
            border-radius: 50%; background: #fff; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .edit-pen-btn { color: var(--pen-color); }
        .edit-pen-btn:hover { background-color: #f0f4ff; border-color: var(--pen-color); }
        
        /* ëª©í‘œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .goal-target-btn { color: var(--target-color); margin-left: 2px; }
        .goal-target-btn:hover { background-color: #ffebee; border-color: var(--target-color); }

        .icon-action-btn svg { pointer-events: none; }
        
        .score-badge {
            background: #E8EAF6; color: var(--primary); padding: 6px 12px;
            border-radius: 20px; font-weight: 700; font-size: 15px;
        }

        .card-body { display: none; background: #fff; padding: 0; border-top: 1px solid #eee; }
        .card-body.active { display: block; }

        .perf-item { padding: 15px 18px; border-bottom: 1px solid #f0f0f0; }
        .perf-row-main { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        
        .perf-left { display: block; flex: 1; min-width: 0; margin-right: 8px; }
        
        .perf-title-text { 
            font-size: 15px; font-weight: 600; color: var(--text-perf); 
            display: inline; line-height: 1.4; word-break: keep-all; 
        }
        .written-exam-text { 
            color: #283593 !important; background-color: #e8eaf6; 
            padding: 3px 6px; border-radius: 4px; font-weight: 700; 
        }

        .perf-ratio-badge {
            font-size: 11px; background: #f1f2f6; color: #666; padding: 2px 6px;
            border-radius: 4px; white-space: nowrap; display: inline-block; vertical-align: middle; margin-left: 4px; margin-bottom: 2px;
        }
        
        .perf-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        
        .score-input {
            width: 70px; padding: 8px; border: 1px solid #bbb !important; 
            border-radius: 6px; text-align: center; font-size: 16px; font-weight: 700; 
            outline: none; background-color: #ffffff !important; color: #000000 !important; 
            -webkit-appearance: none; appearance: none; margin: 0;
        }
        .score-input:focus { border-color: var(--primary) !important; }
        .unit-text { font-size: 14px; color: #333; font-weight: 500; margin-left: 4px; }
        
        .memo-input {
            width: 100%; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px;
            font-size: 12px; resize: none; outline: none; color: #555; overflow-y: hidden; min-height: 40px; line-height: 1.4;
        }
        .memo-input:focus { background: #fff; border-color: #ddd; }

        .final-row { background: #eef2ff; padding: 15px 18px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #c5cae9; }
        .final-label { font-size: 16px; font-weight: 700; color: #333; }
        .final-score { font-size: 20px; font-weight: 800; color: var(--primary); }
        .final-feedback-area { padding: 0 18px 18px 18px; background: #eef2ff; }
        .final-feedback-input { width: 100%; padding: 10px; border: 1px solid #c5cae9; background: white; border-radius: 6px; font-size: 13px; resize: none; overflow-y: hidden; min-height: 50px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; }
        
        .modal { background: white; width: 90%; max-width: 400px; border-radius: 15px; padding: 20px 15px; max-height: 80vh; overflow-y: auto; }
        
        .edit-item-row { 
            display: flex; align-items: center; gap: 3px; 
            margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; 
            padding-bottom: 10px; flex-wrap: nowrap; 
        }
        
        .move-btn-group { display: flex; flex-direction: column; gap: 2px; margin-right: 3px; flex-shrink: 0; }
        .btn-move-row { background: none; border: 1px solid #eee; cursor: pointer; color: #bbb; padding: 0; width: 20px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
        .btn-move-row:hover { background-color: #f0f0f0; color: #666; border-color: #ccc; }
        
        .edit-input-name { flex: 1; min-width: 0; padding: 8px 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .edit-input-ratio { width: 40px; flex: none; padding: 8px 2px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 13px; }
        
        .btn-delete-row { background: none; border: none; cursor: pointer; color: #bbb; padding: 8px; margin-left: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s ease; }
        .btn-delete-row:hover { color: var(--danger); background-color: #ffebee; transform: scale(1.1); }
        .btn-delete-row svg { pointer-events: none; }
        
        .edit-modal-btn-group { display: flex; gap: 8px; margin-top: 20px; }
        .edit-modal-btn-group button { flex: 1; padding: 8px 0; font-size: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; margin: 0; }
        .btn-add-item { background-color: var(--success-bg); color: var(--success-text); border: 1px dashed #a5d6a7; transition: background 0.2s; }
        .btn-add-item:hover { background-color: #c8e6c9; }
        .btn-save-edit { background: var(--primary); color: white; border: none; }
        .btn-cancel-edit { background: #f5f5f5; color: #777; border: 1px solid #ddd; }
        
        .modal h3 { margin-top: 0; color: var(--primary); }
        .modal-desc { font-size: 13px; color: #777; margin-bottom: 15px; margin-top: -10px; line-height: 1.4; }
        
        .btn-save { background: var(--primary); color: white; border: none; padding: 10px 0; border-radius: 8px; font-size: 15px; cursor: pointer; flex: 1; }
        
        .section-box { border: 1px solid #dae0f2; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .section-header { background-color: #eef2ff; padding: 10px 15px; font-size: 14px; font-weight: bold; color: #333; border-bottom: 1px solid #dae0f2; display: flex; justify-content: space-between; align-items: center; }
        .section-content { padding: 12px; background: #fff; }
        .section-content p { margin: 5px 0; font-size: 13px; line-height: 1.5; color: #555; letter-spacing: -1.2px; }
        .section-content b { color: #d32f2f; font-weight: 700; }

        .step-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .step-row p { margin: 0; letter-spacing: -1.2px; flex: 1; }

        .btn-inline-action { padding: 4px 6px; border: 1px solid #ddd; border-radius: 6px; background: #fff; font-size: 11px; font-weight: 600; color: #555; cursor: pointer; transition: background 0.2s; white-space: nowrap; margin-left: 4px; }
        .btn-inline-action:hover { background: #f5f5f5; }
        .btn-inline-action.primary { background-color: #e8eaf6; color: var(--primary); border-color: #c5cae9; }
        .btn-inline-action.success { background-color: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }

        .btn-header-small { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 4px 10px; font-size: 12px; color: #555; cursor: pointer; }
        .btn-header-small:hover { background: #f0f0f0; color: #333; }

        .code-textarea { width: 100%; height: 90px; border: none; background: #fff; font-family: monospace; font-size: 12px; resize: none; outline: none; display: block; color: #333; }
        .code-textarea::placeholder { color: #bbb; }

        .btn-close { background: #f5f5f5; color: #777; border: 1px solid #ddd; padding: 10px 0; border-radius: 8px; font-size: 15px; cursor: pointer; flex: 1; }
        .btn-close:hover { background: #e0e0e0; }
        
        .modal-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        
        .toast-message { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(40, 44, 52, 0.9); color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 2000; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none; }
        .toast-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .empty-state { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }

        .default-semester-area { margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        .default-semester-area label { font-weight: bold; font-size: 14px; color: #333; }
        .default-semester-area select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; }
        
        .note-text { font-size: 12px; color: #777; margin-top: 15px; padding: 0 5px; line-height: 1.4; }

        /* ëª©í‘œ ê³„ì‚° ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼ */
        .goal-grade-selector { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .goal-grade-btn { flex: 1; border: 1px solid #ddd; background: white; padding: 8px 0; border-radius: 6px; cursor: pointer; font-weight: bold; color: #555; font-size: 14px; transition: all 0.2s; }
        .goal-grade-btn.active { background: var(--target-color); color: white; border-color: var(--target-color); }
        
        .goal-input-area { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; background: #fff8e1; padding: 15px; border-radius: 8px; }
        .goal-target-score { width: 80px; padding: 8px; border: 2px solid var(--target-color); border-radius: 6px; font-size: 20px; font-weight: 800; text-align: center; color: var(--target-color); }
        .goal-label { font-weight: bold; color: #555; }
        
        .goal-list-container { max-height: 250px; overflow-y: auto; margin-bottom: 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .goal-item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #f9f9f9; }
        .goal-item-info { flex: 1; }
        .goal-item-name { font-size: 14px; font-weight: 600; color: #333; display: block; margin-bottom: 2px; }
        .goal-item-ratio { font-size: 11px; color: #888; background: #f1f2f6; padding: 2px 5px; border-radius: 4px; }
        
        .goal-item-input-group { display: flex; align-items: center; gap: 5px; }
        .goal-score-input { width: 60px; padding: 6px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; font-size: 14px; }
        .goal-score-input.fixed { background-color: #e0e0e0; color: #555; border-color: #ccc; }
        .goal-score-input.variable { border-color: var(--target-color); color: var(--target-color); background-color: #fff; }
        .goal-score-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(239, 83, 80, 0.2); }
        
        .goal-status-bar { text-align: center; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 14px; margin-bottom: 10px; }
        .goal-status-bar.possible { background-color: #e8f5e9; color: #2e7d32; }
        .goal-status-bar.impossible { background-color: #ffebee; color: #c62828; }
        .goal-status-bar.achieved { background-color: #e3f2fd; color: #1565c0; }

        .goal-helper-text { font-size: 12px; color: #888; text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” ë©”ë‰´ -->
<div id="overlay" onclick="closeSidebar()"></div>
<nav id="sidebar">
    <div class="sidebar-header">
        <span>ğŸ“ í•™ë…„ í•™ê¸° ì„ íƒ</span>
        <span onclick="closeSidebar()" style="cursor:pointer; font-size:24px;">&times;</span>
    </div>
    <ul class="sidebar-menu">
        <li onclick="changeSemester('grade_1_1')" id="menu_grade_1_1">1í•™ë…„ 1í•™ê¸°</li>
        <li onclick="changeSemester('grade_1_2')" id="menu_grade_1_2">1í•™ë…„ 2í•™ê¸°</li>
        <li onclick="changeSemester('grade_2_1')" id="menu_grade_2_1">2í•™ë…„ 1í•™ê¸°</li>
        <li onclick="changeSemester('grade_2_2')" id="menu_grade_2_2">2í•™ë…„ 2í•™ê¸°</li>
        <li onclick="changeSemester('grade_3_1')" id="menu_grade_3_1">3í•™ë…„ 1í•™ê¸°</li>
        <li onclick="changeSemester('grade_3_2')" id="menu_grade_3_2">3í•™ë…„ 2í•™ê¸°</li>
        <li onclick="showTrendView()" class="trend-menu-item">ğŸ“ˆ ê³¼ëª©ë³„ ë³€í™”ë³´ê¸°</li>
    </ul>
</nav>

<header>
    <button class="icon-btn" onclick="openSidebar()">â˜°</button>
    <div class="header-title" id="pageTitle">2í•™ë…„ 2í•™ê¸° ì„±ì ê´€ë¦¬</div>
    <button class="icon-btn" id="settingBtn" onclick="openGlobalSettings()">âš™ï¸</button>
</header>

<div class="container">
    <!-- 1. ë©”ì¸ ì„±ì  ì…ë ¥ ë·° -->
    <div id="mainView" class="view-section active">
        <div class="chart-card">
            <div class="chart-wrapper">
                <canvas id="gradeChart"></canvas>
            </div>
            <!-- í‰ê·  ì ìˆ˜ ëŒ€ì‹œë³´ë“œ -->
            <div id="chartAverageContainer" class="avg-dashboard">
                <div class="avg-box">
                    <span class="avg-label">ì „ì²´ í‰ê· </span>
                    <span class="avg-value main" id="avgTotal">0ì </span>
                </div>
                <div class="avg-box">
                    <span class="avg-label">1ì°¨ í‰ê· </span>
                    <span class="avg-value" id="avgExam1">0ì </span>
                </div>
                <div class="avg-box">
                    <span class="avg-label">2ì°¨ í‰ê· </span>
                    <span class="avg-value" id="avgExam2">0ì </span>
                </div>
            </div>
        </div>
        <div id="subjectList"></div>
    </div>

    <!-- 2. ê³¼ëª©ë³„ ë³€í™” ê·¸ë˜í”„ ë·° -->
    <div id="trendView" class="view-section">
        <!-- ê·¸ë˜í”„ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingModal" class="modal-overlay">
    <div class="modal">
        <h3>âš™ï¸ ì„¤ì • ë° ë°±ì—…</h3>
        
        <div class="default-semester-area">
            <label for="defaultSemesterSelect">ì²« í™”ë©´ í•™ê¸° ì„ íƒ:</label>
            <select id="defaultSemesterSelect">
                <option value="grade_1_1">1í•™ë…„ 1í•™ê¸°</option>
                <option value="grade_1_2">1í•™ë…„ 2í•™ê¸°</option>
                <option value="grade_2_1">2í•™ë…„ 1í•™ê¸°</option>
                <option value="grade_2_2">2í•™ë…„ 2í•™ê¸°</option>
                <option value="grade_3_1">3í•™ë…„ 1í•™ê¸°</option>
                <option value="grade_3_2">3í•™ë…„ 2í•™ê¸°</option>
            </select>
        </div>

        <div class="section-box">
            <div class="section-header">
                ğŸ¤– í‰ê°€í•­ëª©&ë¹„ìœ¨ ìë™ ì…ë ¥
            </div>
            <div class="section-content">
                <p>1ï¸âƒ£ <b>í‰ê°€ê³„íšì„œ ì‚¬ì§„</b>ì„ ì œë¯¸ë‚˜ì´ì— ì—…ë¡œë“œ</p>
                <div class="step-row">
                    <p>2ï¸âƒ£ <b>[í”„ë¡¬í”„íŠ¸ ë³µì‚¬]</b> í›„ ì œë¯¸ë‚˜ì´ì— ì…ë ¥</p>
                    <button class="btn-inline-action primary" onclick="copyPrompt(this)">ğŸ“‹ í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
                </div>
                <p>3ï¸âƒ£ ìƒì„±ëœ ì½”ë“œë¥¼ <b>[ì½”ë“œ ì…ë ¥ì°½]</b>ì— ì…ë ¥</p>
                <p class="note-text">â€» í•­ëª©ëª…, ë¹„ìœ¨ ì˜¤ë¥˜ ì‹œ ê³¼ëª©ëª… ì˜† íœë²„íŠ¼(<span class="icon-action-btn edit-pen-btn" style="display:inline-flex; width:20px; height:20px; vertical-align:middle; border: 1px solid #ccc; padding:0;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></span>)ì—ì„œ ìˆ˜ì •</p>
            </div>
        </div>

        <div class="section-box">
            <div class="section-header">
                ğŸ’¾ ë°±ì—… ë° ë³µêµ¬
            </div>
            <div class="section-content">
                <div class="step-row">
                    <p>1ï¸âƒ£ <b>[ì „ì²´ ë°ì´í„° ë³µì‚¬]</b> ë²„íŠ¼ í´ë¦­</p>
                    <button class="btn-inline-action success" onclick="copyAllData(this)">ğŸ’¾ ì „ì²´ ë°ì´í„° ë³µì‚¬</button>
                </div>
                <p>2ï¸âƒ£ ìƒˆ ì•±ì— ì ‘ì† í›„ <b>[ì½”ë“œ ì…ë ¥ì°½]</b>ì— ë¶™ì—¬ë„£ê³  <b>ì €ì¥ ë° ì ìš©</b></p>
            </div>
        </div>

        <div class="section-box">
            <div class="section-header">
                <span>ğŸ’» ì½”ë“œ ì…ë ¥ì°½</span>
                <button class="btn-header-small" onclick="clearJsonInput()">ğŸ—‘ï¸ ë¹„ìš°ê¸°</button>
            </div>
            <div class="section-content" style="padding:0;">
                <textarea id="jsonConfig" class="code-textarea" placeholder="ì—¬ê¸°ì— ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
            </div>
        </div>
        
        <div class="modal-btn-group">
            <button class="btn-save" onclick="saveGlobalConfig()">ì €ì¥ ë° ì ìš©</button>
            <button class="btn-close" onclick="closeModal('settingModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ê³¼ëª© ìˆ˜ì • ëª¨ë‹¬ -->
<div id="subjectEditModal" class="modal-overlay">
    <div class="modal">
        <h3 id="editModalTitle">ê³¼ëª© ìˆ˜ì •</h3>
        <p class="modal-desc">í•­ëª©ì„ ì¶”ê°€/ì‚­ì œí•˜ê±°ë‚˜ ì´ë¦„, ë¹„ìœ¨, ìˆœì„œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
        <div id="editItemsContainer"></div>
        <div class="edit-modal-btn-group">
            <button class="btn-add-item" onclick="addEditItemRow()">+ í•­ëª© ì¶”ê°€</button>
            <button class="btn-save-edit" onclick="saveSubjectChanges()">ìˆ˜ì • ì™„ë£Œ</button>
            <button class="btn-cancel-edit" onclick="closeModal('subjectEditModal')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- ëª©í‘œ ê³„ì‚°ê¸° ëª¨ë‹¬ -->
<div id="goalModal" class="modal-overlay">
    <div class="modal">
        <h3 id="goalModalTitle">ğŸ¯ ëª©í‘œ ì„¤ì • ë° ê³„ì‚°</h3>
        <p class="modal-desc">ëª©í‘œ ì ìˆ˜ë¥¼ ì„¤ì •í•˜ë©´ ë‚¨ì€ í‰ê°€ì—ì„œ ë°›ì•„ì•¼ í•  ìµœì†Œ ì ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°í•´ì¤ë‹ˆë‹¤.</p>
        
        <div class="goal-grade-selector" id="goalGradeSelector">
            <!-- JSë¡œ ë²„íŠ¼ ìƒì„± -->
        </div>
        
        <div class="goal-input-area">
            <span class="goal-label">ëª©í‘œ ì ìˆ˜</span>
            <input type="number" id="goalTargetScore" class="goal-target-score" value="89.5" step="0.5" oninput="calculateGoalLogic(true)">
            <span class="goal-label">ì </span>
        </div>

        <div id="goalStatusBar" class="goal-status-bar">
            <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        </div>

        <div id="goalItemsList" class="goal-list-container">
            <!-- í•­ëª© ë¦¬ìŠ¤íŠ¸ -->
        </div>
        
        <p class="goal-helper-text">â€» ìë™ ê³„ì‚°ëœ ì ìˆ˜ë¥¼ ìˆ˜ì •í•˜ë©´ ë‚˜ë¨¸ì§€ í•­ëª©ë„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>

        <div class="modal-btn-group">
            <button class="btn-close" onclick="closeModal('goalModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    // --- 0. ì´ˆê¸° ë°ì´í„° ë° ì „ì—­ ë³€ìˆ˜ ---
    const defaultData_2_2 = [
      {
        "subject": "êµ­ì–´",
        "performances": [
          { "name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0 },
          { "name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0 },
          { "name": "ìˆ˜í–‰í‰ê°€", "ratio": 40, "score": 0 }
        ],
        "finalFeedback": ""
      },
      {
        "subject": "ìˆ˜í•™",
        "performances": [
          { "name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0 },
          { "name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0 },
          { "name": "ìˆ˜í–‰í‰ê°€", "ratio": 40, "score": 0 }
        ],
        "finalFeedback": ""
      },
      {
        "subject": "ì˜ì–´",
        "performances": [
          { "name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0 },
          { "name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0 },
          { "name": "ìˆ˜í–‰í‰ê°€", "ratio": 40, "score": 0 }
        ],
        "finalFeedback": ""
      }
    ];

    const emptyTemplate = [
        { subject: "êµ­ì–´", performances: [{"name":"1ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"2ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"ìˆ˜í–‰í‰ê°€", ratio:40, score:0}], finalFeedback:"" },
        { subject: "ìˆ˜í•™", performances: [{"name":"1ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"2ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"ìˆ˜í–‰í‰ê°€", ratio:40, score:0}], finalFeedback:"" },
        { subject: "ì˜ì–´", performances: [{"name":"1ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"2ì°¨ ì§€í•„í‰ê°€", ratio:30, score:0}, {"name":"ìˆ˜í–‰í‰ê°€", ratio:40, score:0}], finalFeedback:"" }
    ];

    let currentSemesterId = 'grade_2_2'; 
    let subjects = []; 
    let myChart = null;
    let trendCharts = [];
    let currentEditIndex = -1;
    
    // ëª©í‘œ ê³„ì‚°ê¸°ìš© ìƒíƒœ ë³€ìˆ˜
    let currentGoalSubjectIndex = -1;
    let goalItemsState = []; // { index: 0, ratio: 30, isFixed: false, currentVal: 0, userModified: false }

    window.onload = function() {
        migrateOldData();
        
        // ê¸°ë³¸ í•™ê¸° ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedDefault = localStorage.getItem('defaultSemesterId');
        currentSemesterId = savedDefault || 'grade_2_2'; 
        
        loadData(currentSemesterId);
        renderSubjects();
        renderChart();
        updateSidebarActiveState();
    };

    function updateSidebarActiveState() {
        document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
        const targetMenu = document.getElementById('menu_' + currentSemesterId);
        if(targetMenu) targetMenu.classList.add('active');
    }

    function migrateOldData() {
        const oldData = localStorage.getItem('gradeAppData_v23');
        const newData = localStorage.getItem('grade_2_2');
        if (oldData && !newData) {
            localStorage.setItem('grade_2_2', oldData);
        }
    }

    function loadData(id) {
        currentSemesterId = id;
        const saved = localStorage.getItem(id);
        
        if (saved) {
            subjects = JSON.parse(saved);
        } else {
            if (id === 'grade_2_2') {
                subjects = JSON.parse(JSON.stringify(defaultData_2_2));
                localStorage.setItem(id, JSON.stringify(subjects));
            } else {
                subjects = JSON.parse(JSON.stringify(emptyTemplate));
            }
        }
        updatePageTitle();
    }

    function saveData() {
        localStorage.setItem(currentSemesterId, JSON.stringify(subjects));
    }

    function openSidebar() {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('overlay').classList.add('show');
    }
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('show');
    }

    function changeSemester(id) {
        currentSemesterId = id;
        updateSidebarActiveState();
        document.getElementById('mainView').classList.add('active');
        document.getElementById('trendView').classList.remove('active');
        document.getElementById('settingBtn').style.display = 'block';
        loadData(id);
        renderSubjects();
        renderChart();
        closeSidebar();
    }

    function updatePageTitle() {
        const map = {
            'grade_1_1': '1í•™ë…„ 1í•™ê¸°', 'grade_1_2': '1í•™ë…„ 2í•™ê¸°',
            'grade_2_1': '2í•™ë…„ 1í•™ê¸°', 'grade_2_2': '2í•™ë…„ 2í•™ê¸°',
            'grade_3_1': '3í•™ë…„ 1í•™ê¸°', 'grade_3_2': '3í•™ë…„ 2í•™ê¸°'
        };
        document.getElementById('pageTitle').innerText = map[currentSemesterId] + " ì„±ì ê´€ë¦¬";
    }

    // --- 3. ê³¼ëª©ë³„ ë³€í™” (Trend) ê¸°ëŠ¥ ---
    function showTrendView() {
        document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
        document.getElementById('mainView').classList.remove('active');
        document.getElementById('trendView').classList.add('active');
        document.getElementById('pageTitle').innerText = "ê³¼ëª©ë³„ ì„±ì  ë³€í™”"; 
        document.getElementById('settingBtn').style.display = 'none'; 
        closeSidebar();
        renderAllTrendCharts();
    }

    // ìˆ˜ì§ì„ (í•™ë…„ êµ¬ë¶„) í”ŒëŸ¬ê·¸ì¸ ì •ì˜
    const verticalLinePlugin = {
        id: 'verticalLine',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
            const separatorIndices = [3.5, 7.5];

            ctx.save();
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#e0e0e0';
            ctx.setLineDash([5, 5]);

            separatorIndices.forEach(index => {
                const xPos = x.getPixelForValue(index);
                if (xPos >= x.left && xPos <= x.right) { 
                     ctx.moveTo(xPos, top);
                     ctx.lineTo(xPos, bottom);
                }
            });

            ctx.stroke();
            ctx.restore();
        }
    };

    // "ìˆ˜í–‰" ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸
    const perfLabelPlugin = {
        id: 'perfLabel',
        afterDatasetsDraw: (chart) => {
            const { ctx, chartArea: { top } } = chart; 
            chart.data.datasets.forEach((dataset, i) => {
                const meta = chart.getDatasetMeta(i);
                meta.data.forEach((element, index) => {
                    if (dataset.pointFlags && dataset.pointFlags[index] === 'performance' && !element.skip) {
                        const x = element.x;
                        const y = element.y;
                        
                        ctx.save();
                        ctx.fillStyle = '#666'; 
                        ctx.font = 'bold 10px sans-serif';
                        ctx.textAlign = 'center';
                        
                        if (y - 20 < top) {
                            ctx.textBaseline = 'top';
                            ctx.fillText('ìˆ˜í–‰', x, y + 10);
                        } else {
                            ctx.textBaseline = 'bottom';
                            ctx.fillText('ìˆ˜í–‰', x, y - 8);
                        }
                        ctx.restore();
                    }
                });
            });
        }
    };

    function renderAllTrendCharts() {
        const trendContainer = document.getElementById('trendView');
        trendContainer.innerHTML = ''; 
        
        trendCharts.forEach(chart => chart.destroy());
        trendCharts = [];

        const semesters = ['grade_1_1', 'grade_1_2', 'grade_2_1', 'grade_2_2', 'grade_3_1', 'grade_3_2'];
        const labels = ['1-1 1ì°¨', '1-1 2ì°¨', '1-2 1ì°¨', '1-2 2ì°¨', '2-1 1ì°¨', '2-1 2ì°¨', '2-2 1ì°¨', '2-2 2ì°¨', '3-1 1ì°¨', '3-1 2ì°¨', '3-2 1ì°¨', '3-2 2ì°¨'];

        let allSubjects = new Set();
        const defaultRaw = localStorage.getItem('grade_2_2');
        if(defaultRaw) {
            JSON.parse(defaultRaw).forEach(s => allSubjects.add(s.subject));
        }

        semesters.forEach(sem => {
            const raw = localStorage.getItem(sem);
            if(raw) {
                JSON.parse(raw).forEach(s => allSubjects.add(s.subject));
            }
        });
        
        const subjectsList = Array.from(allSubjects);

        if (subjectsList.length === 0) {
            trendContainer.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê° í•™ê¸°ë³„ë¡œ ê³¼ëª©ê³¼ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
            return;
        }

        subjectsList.forEach((subjectName, idx) => {
            const scores = [];
            const pointFlags = []; 
            let isWrittenSubject = false; 

            semesters.forEach(sem => {
                const raw = localStorage.getItem(sem);
                let s1 = null, s2 = null;
                let s1Flag = null, s2Flag = null; 

                if(raw) {
                    const data = JSON.parse(raw);
                    const subj = data.find(s => s.subject === subjectName);
                    if(subj) {
                        const hasWrittenExam = subj.performances.some(p => checkIsWrittenExam(p.name));
                        
                        if (hasWrittenExam) {
                            isWrittenSubject = true; 
                            const exam1 = subj.performances.find(p => (p.name.includes("1ì°¨") || p.name.includes("ì¤‘ê°„")) && checkIsWrittenExam(p.name));
                            const exam2 = subj.performances.find(p => (p.name.includes("2ì°¨") || p.name.includes("ê¸°ë§")) && checkIsWrittenExam(p.name));
                            if(exam1 && exam1.score > 0) s1 = exam1.score;
                            if(exam2 && exam2.score > 0) s2 = exam2.score;
                        } else {
                            const total = calculateTotal(subj);
                            const finalScore = truncateScore(total);
                            if (finalScore > 0) {
                                s2 = finalScore; 
                                s2Flag = 'performance'; 
                            }
                        }
                    }
                }
                scores.push(s1);
                scores.push(s2);
                pointFlags.push(s1Flag);
                pointFlags.push(s2Flag);
            });

            const trendLabel = isWrittenSubject ? "ì§€í•„í‰ê°€ ë³€í™”" : "";

            const card = document.createElement('div');
            card.className = 'chart-card';
            let html = `<div class="trend-title-area"><h3>${subjectName}</h3>`;
            if (trendLabel) {
                html += `<p>${trendLabel}</p>`;
            }
            html += `</div><div class="chart-wrapper" style="height: 200px;"><canvas id="trendChart_${idx}"></canvas></div>`;
            card.innerHTML = html;
            trendContainer.appendChild(card);

            const ctx = document.getElementById(`trendChart_${idx}`).getContext('2d');
            const color = getColor(idx);

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì ìˆ˜',
                        data: scores,
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        fill: false,
                        tension: 0.2,
                        spanGaps: true,
                        pointFlags: pointFlags,
                        pointHitRadius: 30 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false,
                        axis: 'x'
                    },
                    onClick: (e, activeElements, chart) => {
                        if (activeElements.length > 0) {
                            const activeIndex = activeElements[0].index;
                            const datasetIndex = activeElements[0].datasetIndex;
                            
                            if (chart.lastActiveIndex === activeIndex && chart.lastActiveDatasetIndex === datasetIndex) {
                                chart.setActiveElements([]);
                                chart.tooltip.setActiveElements([], {x: 0, y: 0});
                                chart.update();
                                chart.lastActiveIndex = null;
                                chart.lastActiveDatasetIndex = null;
                            } else {
                                chart.lastActiveIndex = activeIndex;
                                chart.lastActiveDatasetIndex = datasetIndex;
                            }
                        } else {
                            chart.lastActiveIndex = null;
                            chart.lastActiveDatasetIndex = null;
                        }
                    },
                    events: ['click'], 
                    scales: {
                        y: { 
                            beginAtZero: false, 
                            min: 50, 
                            max: 100, 
                            grid: { borderDash: [2, 4] }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } }
                        }
                    },
                    layout: {
                        padding: {
                            top: 30, 
                            left: 10,
                            right: 10,
                            bottom: 5
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            enabled: true, 
                            yAlign: 'bottom', 
                            displayColors: false, 
                            backgroundColor: 'rgba(0, 0, 0, 0.8)', 
                            padding: 10,      
                            caretSize: 0,     
                            caretPadding: 8,  
                            cornerRadius: 6,  
                            titleFont: { size: 0 }, 
                            bodyFont: { size: 14, weight: 'bold' }, 
                            callbacks: { 
                                title: () => null, 
                                label: function(context) { 
                                    return context.raw + 'ì '; 
                                } 
                            } 
                        }
                    }
                },
                plugins: [verticalLinePlugin, perfLabelPlugin] 
            });
            trendCharts.push(chart);
        });
    }

    function getColor(idx) {
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        return colors[idx % colors.length];
    }

    function checkIsWrittenExam(name) {
        return name.includes("ì§€í•„") || (name.includes("ê³ ì‚¬") && !name.includes("ê³ ì‚¬ì„±ì–´"));
    }

    function calculateTotal(sub) {
        return sub.performances.reduce((acc, curr) => {
            if (checkIsWrittenExam(curr.name)) {
                return acc + (curr.score * (curr.ratio / 100));
            } else {
                return acc + curr.score;
            }
        }, 0);
    }
    
    function calculateExamAvg(nth) {
        let total = 0;
        let count = 0;
        subjects.forEach(sub => {
            const perf = sub.performances.find(p => {
                const isWritten = checkIsWrittenExam(p.name);
                if (!isWritten) return false;
                if (nth === "1ì°¨") return p.name.includes("1ì°¨") || p.name.includes("ì¤‘ê°„");
                if (nth === "2ì°¨") return p.name.includes("2ì°¨") || p.name.includes("ê¸°ë§");
                return false;
            });
            if (perf) {
                total += perf.score;
                count++;
            }
        });
        return count === 0 ? 0 : truncateScore(total / count);
    }
    
    function truncateScore(num) {
        return Math.floor(Number(num.toFixed(4)) * 10) / 10;
    }

    function getGrade(score, subject) {
        if (score === 0) return '';
        const rounded = Math.round(score);
        
        if (['ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡'].includes(subject)) {
            if (rounded >= 80) return 'A';
            if (rounded >= 60) return 'B';
            return 'C';
        } else {
            // [ìˆ˜ì •ë¨] ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ë°˜ì˜¬ë¦¼ ê¸°ì¤€ ì ìš©
            if (rounded >= 90) return 'A'; // 89.5 ì´ìƒ
            if (rounded >= 80) return 'B'; // 79.5 ì´ìƒ
            if (rounded >= 70) return 'C'; // 69.5 ì´ìƒ
            if (rounded >= 60) return 'D'; // 59.5 ì´ìƒ
            return 'E';
        }
    }

    function getBarColor(score, subject) {
        const grade = getGrade(score, subject);
        if (grade === 'A') return 'rgba(63, 81, 181, 0.8)';
        if (grade === 'B') return 'rgba(76, 175, 80, 0.8)';
        if (grade === 'C') return 'rgba(255, 193, 7, 0.8)';
        if (grade === 'D') return 'rgba(255, 152, 0, 0.8)';
        return 'rgba(244, 67, 54, 0.8)';
    }

    function getGradeText(score, subjectName) {
        const grade = getGrade(score, subjectName);
        if (!grade) return '';
        return ` (${grade})`;
    }

    function autoResize(textarea) {
        textarea.style.height = '1px';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function renderSubjects() {
        const list = document.getElementById('subjectList');
        list.innerHTML = '';
        subjects.forEach((sub, subIdx) => {
            let totalScore = calculateTotal(sub);
            let displayScore = truncateScore(totalScore); 
            let gradeText = getGradeText(totalScore, sub.subject);
            const perfCount = sub.performances.filter(p => !checkIsWrittenExam(p.name)).length;
            const card = document.createElement('div');
            card.className = 'subject-card';
            let html = `
                <div class="card-header" onclick="toggleCard(event, this)">
                    <div class="subject-info">
                        <h3>${sub.subject}</h3>
                        <div class="icon-action-btn edit-pen-btn" onclick="openSubjectEditModal(event, ${subIdx})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </div>
                        <div class="icon-action-btn goal-target-btn" onclick="openGoalModal(event, ${subIdx})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        </div>
                    </div>
                    <div class="score-badge">${displayScore}ì ${gradeText}</div>
                </div>
                <span style="display:block; padding:0 18px; margin-top:-10px; margin-bottom:10px; font-size:12px; color:#666;">ìˆ˜í–‰í‰ê°€ í•­ëª© (${perfCount}ê°œ)</span>
                <div class="card-body">
            `;
            sub.performances.forEach((perf, perfIdx) => {
                const isWrittenExam = checkIsWrittenExam(perf.name);
                const titleClass = isWrittenExam ? "perf-title-text written-exam-text" : "perf-title-text";
                let inputValue = perf.score > 0 ? truncateScore(perf.score) : '';
                
                html += `
                    <div class="perf-item">
                        <div class="perf-row-main">
                            <div class="perf-left"><span class="${titleClass}">${perf.name}</span><span class="perf-ratio-badge">ë¹„ìœ¨ ${perf.ratio}%</span></div>
                            <div class="perf-right">
                                <input type="number" step="0.1" class="score-input" placeholder="0" min="0" max="100" value="${inputValue}" onchange="updateScore(${subIdx}, ${perfIdx}, this.value)">
                                <span class="unit-text">ì </span>
                            </div>
                        </div>
                        <textarea class="memo-input" rows="1" placeholder="ê°ì ì‚¬í•­ ê¸°ë¡" oninput="autoResize(this)" onchange="updateMemo(${subIdx}, ${perfIdx}, this.value)">${perf.memo || ''}</textarea>
                    </div>`;
            });
            html += `<div class="final-row"><span class="final-label">ìµœì¢… ì ìˆ˜</span><span class="final-score">${displayScore}ì </span></div>
                     <div class="final-feedback-area"><textarea class="final-feedback-input" rows="2" placeholder="ì´í‰ì„ ì…ë ¥í•˜ì„¸ìš”." oninput="autoResize(this)" onchange="updateFinalFeedback(${subIdx}, this.value)">${sub.finalFeedback || ''}</textarea></div></div>`;
            card.innerHTML = html;
            list.appendChild(card);
        });
        setTimeout(() => { document.querySelectorAll('.memo-input, .final-feedback-input').forEach(el => autoResize(el)); }, 10);
    }

    function toggleCard(event, header) {
        if (event.target.closest('.icon-action-btn')) return;
        const body = header.nextElementSibling.nextElementSibling;
        const allBodies = document.querySelectorAll('.card-body');
        const isActive = body.classList.contains('active');
        allBodies.forEach(b => { b.classList.remove('active'); });
        if (!isActive) { body.classList.add('active'); setTimeout(() => { body.querySelectorAll('textarea').forEach(el => autoResize(el)); }, 50); }
    }

    function updateScore(subIdx, perfIdx, val) {
        let score = parseFloat(val); if (isNaN(score)) score = 0; if (score > 100) score = 100; if (score < 0) score = 0;
        subjects[subIdx].performances[perfIdx].score = score;
        saveData(); renderSubjects(); updateChartData();
        setTimeout(() => { 
            const bodies = document.querySelectorAll('.card-body');
            if(bodies[subIdx]) { bodies[subIdx].classList.add('active'); bodies[subIdx].querySelectorAll('textarea').forEach(el => autoResize(el)); }
        }, 10);
    }
    
    function updateMemo(subIdx, perfIdx, val) { subjects[subIdx].performances[perfIdx].memo = val; saveData(); }
    function updateFinalFeedback(subIdx, val) { subjects[subIdx].finalFeedback = val; saveData(); }

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function openSubjectEditModal(event, subIdx) {
        event.stopPropagation(); currentEditIndex = subIdx;
        const subject = subjects[subIdx];
        document.getElementById('editModalTitle').innerText = `[${subject.subject}] ìˆ˜ì •`;
        const container = document.getElementById('editItemsContainer'); container.innerHTML = '';
        subject.performances.forEach((perf, idx) => { addEditRowToModal(perf.name, perf.ratio, idx); });
        document.getElementById('subjectEditModal').style.display = 'flex';
    }
    function addEditRowToModal(name = "", ratio = "", originalIndex = -1) {
        const container = document.getElementById('editItemsContainer');
        const row = document.createElement('div'); row.className = 'edit-item-row'; row.dataset.originalIndex = originalIndex;
        row.innerHTML = `
            <div class="move-btn-group"><button class="btn-move-row" onclick="moveRowUp(this)">â–²</button><button class="btn-move-row" onclick="moveRowDown(this)">â–¼</button></div>
            <input type="text" class="edit-input-name" value="${name}" placeholder="í•­ëª©ëª…">
            <input type="number" class="edit-input-ratio" value="${ratio}" placeholder="ë¹„ìœ¨"><span>%</span>
            <button class="btn-delete-row" type="button" onclick="removeEditItemRow(this)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
        container.appendChild(row);
    }
    function addEditItemRow() { addEditRowToModal(); const modal = document.querySelector('#subjectEditModal .modal'); setTimeout(() => modal.scrollTop = modal.scrollHeight, 10); }
    function moveRowUp(btn) { const row = btn.closest('.edit-item-row'); const prev = row.previousElementSibling; if (prev) row.parentNode.insertBefore(row, prev); }
    function moveRowDown(btn) { const row = btn.closest('.edit-item-row'); const next = row.nextElementSibling; if (next) row.parentNode.insertBefore(next, row); }
    function removeEditItemRow(btn) { btn.closest('.edit-item-row').remove(); }
    
    function saveSubjectChanges() {
        try {
            if (currentEditIndex === -1) return;
            const container = document.getElementById('editItemsContainer'); const rows = container.querySelectorAll('.edit-item-row');
            const newPerfs = [];
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const name = row.querySelector('.edit-input-name').value.trim();
                let ratio = parseFloat(row.querySelector('.edit-input-ratio').value); if (isNaN(ratio)) ratio = 0;
                const originalIndex = parseInt(row.dataset.originalIndex);
                let score = 0; let memo = "";
                if (originalIndex !== -1 && subjects[currentEditIndex].performances[originalIndex]) {
                    score = subjects[currentEditIndex].performances[originalIndex].score;
                    memo = subjects[currentEditIndex].performances[originalIndex].memo;
                }
                newPerfs.push({ name, ratio, score, memo });
            }
            subjects[currentEditIndex].performances = newPerfs; saveData();
            closeModal('subjectEditModal'); renderSubjects(); renderChart(); showToast("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (error) { showToast("ì˜¤ë¥˜ ë°œìƒ: " + error.message); }
    }

    // --- ëª©í‘œ ê³„ì‚° ê¸°ëŠ¥ ---
    function openGoalModal(event, subIdx) {
        event.stopPropagation();
        currentGoalSubjectIndex = subIdx;
        const subject = subjects[subIdx];
        
        document.getElementById('goalModalTitle').innerText = `ğŸ¯ [${subject.subject}] ëª©í‘œ ê³„ì‚°`;
        
        // ë“±ê¸‰ ë²„íŠ¼ ìƒì„±
        const selector = document.getElementById('goalGradeSelector');
        selector.innerHTML = '';
        
        const isArtSubject = ['ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡'].includes(subject.subject);
        const grades = isArtSubject ? ['A', 'B', 'C'] : ['A', 'B', 'C', 'D', 'E'];
        
        grades.forEach(g => {
            const btn = document.createElement('button');
            btn.className = 'goal-grade-btn';
            btn.innerText = g + ' ë“±ê¸‰';
            btn.onclick = () => setGoalGrade(g);
            selector.appendChild(btn);
        });
        
        // ì´ˆê¸°í™”: ëª©í‘œ ì ìˆ˜ 89.5ìœ¼ë¡œ ì‹œì‘ (Aë“±ê¸‰ ê¸°ì¤€)
        document.getElementById('goalTargetScore').value = isArtSubject ? 79.5 : 89.5;
        
        // ë°ì´í„° ì¤€ë¹„
        goalItemsState = subject.performances.map((p, idx) => {
            // ì ìˆ˜ê°€ 0ë³´ë‹¤ í¬ë©´ 'ì´ë¯¸ ì…ë ¥ë¨(Fixed)'ë¡œ ê°„ì£¼
            const isFixed = p.score > 0; 
            return {
                index: idx,
                name: p.name,
                ratio: p.ratio,
                isWritten: checkIsWrittenExam(p.name), // ì§€í•„í‰ê°€ ì—¬ë¶€ ì²´í¬
                isFixed: isFixed,
                currentVal: isFixed ? p.score : 0, // ì´ˆê¸°ê°’
                userModified: false // ìœ ì €ê°€ ëª¨ë‹¬ ì•ˆì—ì„œ ìˆ˜ì •í–ˆëŠ”ì§€ ì—¬ë¶€
            };
        });
        
        // ì´ˆê¸° ê³„ì‚° ë° ë Œë”ë§
        calculateGoalLogic(true);
        
        document.getElementById('goalModal').style.display = 'flex';
    }

    function setGoalGrade(grade) {
        const subject = subjects[currentGoalSubjectIndex];
        const isArt = ['ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡'].includes(subject.subject);
        let score = 89.5;
        
        if (isArt) {
            if (grade === 'A') score = 79.5; // 80 -> 79.5 (ë°˜ì˜¬ë¦¼)
            else if (grade === 'B') score = 59.5; // 60 -> 59.5 (ë°˜ì˜¬ë¦¼)
            else score = 0; // C
        } else {
            // [ìˆ˜ì •ë¨] ë°˜ì˜¬ë¦¼ ê¸°ì¤€ ëª©í‘œ ì ìˆ˜ ì ìš©
            if (grade === 'A') score = 89.5;
            else if (grade === 'B') score = 79.5;
            else if (grade === 'C') score = 69.5;
            else if (grade === 'D') score = 59.5;
            else score = 0; // E
        }
        
        document.getElementById('goalTargetScore').value = score;
        
        // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼
        document.querySelectorAll('.goal-grade-btn').forEach(b => {
            if (b.innerText.startsWith(grade)) b.classList.add('active');
            else b.classList.remove('active');
        });
        
        // ë¦¬ì…‹: ë“±ê¸‰ì„ ë°”ê¾¸ë©´ ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ê°’ë„ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ ê· ë“± ë¶„ë°°
        goalItemsState.forEach(item => {
            if (!item.isFixed) item.userModified = false;
        });
        
        calculateGoalLogic(true);
    }
    
    // ê³„ì‚° ë¡œì§ (isReset: ì „ë¶€ ë‹¤ì‹œ ê· ë“±ë¶„ë°° í• ì§€ ì—¬ë¶€)
    function calculateGoalLogic(isReset = false) {
        const targetScore = parseFloat(document.getElementById('goalTargetScore').value) || 0;
        
        let fixedTotalScore = 0; 
        let userModifiedTotalScore = 0;
        let remainingRatio = 0;
        
        // 1. ì ìˆ˜ í•©ì‚° ë¡œì§ (ì§€í•„ì€ ë¹„ìœ¨ ì ìš©, ìˆ˜í–‰ì€ ê·¸ëŒ€ë¡œ ë”í•˜ê¸°)
        goalItemsState.forEach(item => {
            let contribution = 0;
            if (item.isWritten) {
                // ì§€í•„í‰ê°€: 100ì  ë§Œì  ê¸°ì¤€ -> ë¹„ìœ¨ ì ìš©
                contribution = item.currentVal * (item.ratio / 100);
            } else {
                // ìˆ˜í–‰í‰ê°€: ì…ë ¥ê°’ì´ ê³§ ë°˜ì˜ ì ìˆ˜ (ë¹„ìœ¨ ì´ë¯¸ ë°˜ì˜ëœ ìƒíƒœë¡œ ê°€ì •)
                contribution = item.currentVal;
            }

            if (item.isFixed) {
                // ë©”ì¸í™”ë©´ì—ì„œ ì´ë¯¸ ì…ë ¥ëœ ê°’
                fixedTotalScore += contribution;
            } else if (item.userModified && !isReset) {
                // ëª¨ë‹¬ì—ì„œ ìœ ì €ê°€ ìˆ˜ì •í•œ ê°’
                userModifiedTotalScore += contribution;
            } else {
                // ìë™ ê³„ì‚° ëŒ€ìƒ (ë¹„ìœ¨ ëˆ„ì )
                remainingRatio += item.ratio;
            }
        });

        // ëª©í‘œê¹Œì§€ ë‚¨ì€ ì ìˆ˜ (ì‹¤ì œ ì ìˆ˜ ê¸°ì¤€)
        const neededScore = targetScore - fixedTotalScore - userModifiedTotalScore;
        
        let possible = true;
        let message = "";
        let statusClass = "possible";

        // 2. ë‚¨ì€ ì ìˆ˜ ë¶„ë°°
        if (remainingRatio > 0) {
            // "ë‚¨ì€ ì ìˆ˜(neededScore)"ë¥¼ "ë‚¨ì€ ë¹„ìœ¨(remainingRatio)"ì— ë§ì¶°ì„œ
            // 100ì  ë§Œì  í™˜ì‚° ì ìˆ˜(effort)ë¥¼ êµ¬í•¨
            // effort * (remainingRatio / 100) = neededScore
            // effort = neededScore * 100 / remainingRatio
            
            let effortScore = (neededScore * 100) / remainingRatio;
            
            // ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ ì˜¬ë¦¼
            effortScore = Math.ceil(effortScore * 10) / 10;
            
            if (effortScore < 0) effortScore = 0; // ì´ë¯¸ ë‹¬ì„±í•¨
            
            // ìƒíƒœ ì²´í¬ (100ì  ë§Œì  ê¸°ì¤€ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•œì§€ ì²´í¬)
            if (effortScore > 100) {
                possible = false;
                message = `ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤ (í‰ê·  ${effortScore}ì  í•„ìš”)`;
                statusClass = "impossible";
            } else if (effortScore <= 0) {
                 message = "ì´ë¯¸ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! (0ì  ì´ìƒ)";
                 statusClass = "achieved";
            } else {
                 message = `ë‚¨ì€ í•­ëª© í‰ê·  ${effortScore}ì  í•„ìš”`;
                 statusClass = "possible";
            }
            
            // 3. ê° í•­ëª©ì— ì ìˆ˜ í• ë‹¹ (UIì— ë³´ì—¬ì§ˆ ê°’)
            goalItemsState.forEach(item => {
                if (!item.isFixed && (!item.userModified || isReset)) {
                    let valToSet = 0;
                    if (item.isWritten) {
                        // ì§€í•„í‰ê°€ëŠ” 100ì  ë§Œì  ì ìˆ˜ í‘œì‹œ
                        valToSet = effortScore;
                    } else {
                        // ìˆ˜í–‰í‰ê°€ëŠ” ë°˜ì˜ ì ìˆ˜(ë¹„ìœ¨ ì ìˆ˜) í‘œì‹œ
                        // 100ì  ë§Œì  í™˜ì‚°ì ìˆ˜(effort)ë¥¼ ë‹¤ì‹œ ë¹„ìœ¨ì— ë§ê²Œ ì¶•ì†Œ
                        valToSet = effortScore * (item.ratio / 100);
                        // ì†Œìˆ˜ì  ì •ë¦¬
                        valToSet = Math.round(valToSet * 10) / 10;
                    }
                    
                    item.currentVal = valToSet;
                    item.userModified = false; // ìë™ ê³„ì‚°ëœ ìƒíƒœë¡œ ì„¤ì •
                }
            });
            
        } else {
            // ë‚¨ì€ ë¹„ìœ¨ì´ 0ì¸ ê²½ìš° (ëª¨ë“  í•­ëª©ì´ ê³ ì •ë˜ì—ˆê±°ë‚˜ ìœ ì €ê°€ ìˆ˜ì •í•¨)
            if (neededScore <= 0.001) { // ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ê³ ë ¤
                 message = "ëª©í‘œ ë‹¬ì„± ê°€ëŠ¥!";
                 statusClass = "achieved";
            } else {
                 message = `ì ìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (${Math.round(neededScore*10)/10}ì  ë¶€ì¡±)`;
                 statusClass = "impossible";
            }
        }

        // UI ë Œë”ë§
        const statusEl = document.getElementById('goalStatusBar');
        statusEl.className = 'goal-status-bar ' + statusClass;
        statusEl.innerText = message;
        
        renderGoalList();
    }

    function renderGoalList() {
        const container = document.getElementById('goalItemsList');
        container.innerHTML = '';
        
        goalItemsState.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = 'goal-item-row';
            
            let inputHtml = '';
            if (item.isFixed) {
                inputHtml = `
                    <div class="goal-item-input-group">
                        <span style="font-size:12px; color:#666;">ê¸°ì¡´ì ìˆ˜</span>
                        <input type="number" class="goal-score-input fixed" value="${item.currentVal}" disabled>
                        <span class="unit-text">ì </span>
                    </div>`;
            } else {
                inputHtml = `
                    <div class="goal-item-input-group">
                        <span style="font-size:12px; color:var(--target-color); font-weight:bold;">ëª©í‘œì ìˆ˜</span>
                        <input type="number" class="goal-score-input variable" value="${item.currentVal}" 
                               onchange="onGoalItemChange(${idx}, this.value)">
                        <span class="unit-text">ì </span>
                    </div>`;
            }
            
            row.innerHTML = `
                <div class="goal-item-info">
                    <span class="goal-item-name">${item.name}</span>
                    <span class="goal-item-ratio">${item.ratio}%</span>
                </div>
                ${inputHtml}
            `;
            container.appendChild(row);
        });
    }

    function onGoalItemChange(idx, val) {
        const newVal = parseFloat(val);
        if (isNaN(newVal)) return;
        
        // í•´ë‹¹ ì•„ì´í…œì„ ì‚¬ìš©ì ìˆ˜ì • ìƒíƒœë¡œ ë³€ê²½
        goalItemsState[idx].currentVal = newVal;
        goalItemsState[idx].userModified = true;
        
        // ë‚˜ë¨¸ì§€ë¥¼ ì¬ê³„ì‚° (reset=false)
        calculateGoalLogic(false);
    }

    function openGlobalSettings() { 
        document.getElementById('jsonConfig').value = JSON.stringify(subjects, null, 2); 
        
        // ì €ì¥ëœ ê¸°ë³¸ í•™ê¸°ê°’ ë¶ˆëŸ¬ì™€ì„œ ì„¸íŒ…
        const savedDefault = localStorage.getItem('defaultSemesterId') || 'grade_2_2';
        document.getElementById('defaultSemesterSelect').value = savedDefault;

        document.getElementById('settingModal').style.display = 'flex'; 
    }

    function saveGlobalConfig() {
        try {
            // 1. ë°ì´í„° íŒŒì‹±
            const inputValue = document.getElementById('jsonConfig').value;
            if (!inputValue.trim()) {
                showToast("ì…ë ¥ëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const parsedData = JSON.parse(inputValue);
            
            // 2. ê¸°ë³¸ í•™ê¸° ì„¤ì • ì €ì¥ (í•­ìƒ ìˆ˜í–‰)
            const selectedDefault = document.getElementById('defaultSemesterSelect').value;
            localStorage.setItem('defaultSemesterId', selectedDefault);

            // 3. ë°ì´í„° í˜•íƒœì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
            if (Array.isArray(parsedData)) {
                // Case A: ë‹¨ì¼ í•™ê¸° ë°ì´í„° (ë°°ì—´ í˜•íƒœ) -> í˜„ì¬ í•™ê¸°ì—ë§Œ ì ìš©
                subjects = parsedData;
                saveData(); // í˜„ì¬ semesterIdë¡œ ì €ì¥
                renderSubjects();
                renderChart();
                showToast("í˜„ì¬ í•™ê¸° ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else if (typeof parsedData === 'object') {
                // Case B: ì „ì²´ ë°±ì—… ë°ì´í„° (ê°ì²´ í˜•íƒœ) -> ëª¨ë“  í•™ê¸° ë³µêµ¬
                // ì˜ˆ: { "grade_1_1": [...], "grade_1_2": [...] }
                let restoreCount = 0;
                for (const [key, value] of Object.entries(parsedData)) {
                    if (key.startsWith('grade_') && Array.isArray(value)) {
                        localStorage.setItem(key, JSON.stringify(value));
                        restoreCount++;
                    }
                }
                
                // í˜„ì¬ ë³´ê³  ìˆëŠ” í•™ê¸°ì˜ ë°ì´í„°ë„ ê°±ì‹ 
                loadData(currentSemesterId);
                renderSubjects();
                renderChart();
                
                if (restoreCount > 0) {
                    showToast(`ì´ ${restoreCount}ê°œ í•™ê¸°ì˜ ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    showToast("ë³µêµ¬í•  ìœ íš¨í•œ í•™ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            } else {
                throw new Error("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
            }

            closeModal('settingModal'); 
        } catch(e) { 
            console.error(e);
            showToast("JSON ì½”ë“œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
        }
    }
    
    // ì…ë ¥ì°½ ë¹„ìš°ê¸° í•¨ìˆ˜ ì¶”ê°€
    function clearJsonInput() {
        const textarea = document.getElementById('jsonConfig');
        textarea.value = '';
        textarea.focus();
    }

    function copyPrompt(btnElement) {
        const promptText = `ì´ ì´ë¯¸ì§€ì— ìˆëŠ” í‰ê°€ ê³„íší‘œë¥¼ ë¶„ì„í•´ì„œ ì•„ë˜ JSON í¬ë§·ì˜ ì½”ë“œë¡œ ë³€í™˜í•´ì¤˜.\nì˜¤ì§ JSON ì½”ë“œë§Œ ì¶œë ¥í•´.\n\n[ìš”êµ¬ì‚¬í•­]\n1. ê³¼ëª©ë³„ë¡œ ìˆ˜í–‰í‰ê°€ í•­ëª©ê³¼ ì§€í•„í‰ê°€(ì¤‘ê°„/ê¸°ë§ ë“±)ë¥¼ ëª¨ë‘ í¬í•¨í•  ê²ƒ.\n2. 'ì§€í•„í‰ê°€'ëŠ” ì´ë¦„ì— ë°˜ë“œì‹œ 'ì§€í•„í‰ê°€' ë˜ëŠ” 'ê³ ì‚¬'ë¼ëŠ” ë‹¨ì–´ë¥¼ í¬í•¨í•  ê²ƒ.\n3. ìˆ˜í–‰í‰ê°€ë‚˜ ì§€í•„í‰ê°€ì˜ ë¹„ìœ¨(%)ì€ ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ 'ratio'ì— ë„£ì„ ê²ƒ.\n4. JSON êµ¬ì¡°ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ë”°ë¥¼ ê²ƒ.\n5. performances ë°°ì—´ì˜ ìˆœì„œëŠ” ë°˜ë“œì‹œ [ëª¨ë“  ìˆ˜í–‰í‰ê°€ í•­ëª©ë“¤]ì„ ë¨¼ì € ë‚˜ì—´í•˜ê³ , ê·¸ ë’¤ì— [1ì°¨ ì§€í•„í‰ê°€, 2ì°¨ ì§€í•„í‰ê°€] ìˆœì„œë¡œ ë°°ì¹˜í•  ê²ƒ.\n6. í‘œì— ì§€í•„í‰ê°€ ë¹„ìœ¨ì´ ì—†ê±°ë‚˜ '-' í‘œì‹œê°€ ë˜ì–´ ìˆê±°ë‚˜ 0%ì¸ ê²½ìš°, í•´ë‹¹ ì§€í•„í‰ê°€ í•­ëª©ì€ ì ˆëŒ€ë¡œ ìƒì„±í•˜ì§€ ë§ ê²ƒ.\n7. ìˆ˜í–‰í‰ê°€ ë§Œìœ¼ë¡œ 100%ì¸ ê²½ìš°, ì§€í•„í‰ê°€ í•­ëª©ì„ ì–µì§€ë¡œ ì¶”ê°€í•˜ì§€ ë§ ê²ƒ.\n8. (ì¤‘ìš”) ì§€í•„í‰ê°€ í•­ëª©ì—ì„œ 'ì„ íƒí˜•', 'ì„œìˆ í˜•', 'ë…¼ìˆ í˜•'ì€ ë³„ë„ í•­ëª©ìœ¼ë¡œ ë‚˜ëˆ„ì§€ ë§ê³ , í•´ë‹¹ ì°¨ìˆ˜(1ì°¨ ë˜ëŠ” 2ì°¨)ì˜ í•©ê³„ ë¹„ìœ¨ë¡œ í•©ì³ì„œ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ ë§Œë“¤ ê²ƒ. (ì˜ˆ: 2ì°¨ ì„ íƒí˜• 40% + 2ì°¨ ë…¼ìˆ í˜• 10% -> '2ì°¨ ì§€í•„í‰ê°€' 50%)\n9. (ë§¤ìš° ì¤‘ìš”) ì§€í•„í‰ê°€ì˜ ì´ë¦„ì€ í‘œì˜ í—¤ë”(1ì°¨, 2ì°¨, ì¤‘ê°„, ê¸°ë§)ë¥¼ ì •í™•íˆ ë°˜ì˜í•  ê²ƒ. ë§Œì•½ 1ì°¨ê°€ ì—†ê³  2ì°¨ë§Œ ìˆë‹¤ë©´, í•­ëª© ì´ë¦„ì„ ë°˜ë“œì‹œ '2ì°¨ ì§€í•„í‰ê°€'ë¡œ ì ì„ ê²ƒ. ('1ì°¨'ë¡œ ì„ì˜ ë³€ê²½ ê¸ˆì§€)\n\n[\n  {\n    "subject": "ê³¼ëª©ëª…",\n    "performances": [\n      {"name": "í‰ê°€í•­ëª©ëª…", "ratio": 20, "score": 0, "memo": ""},\n      {"name": "1ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0, "memo": ""},\n      {"name": "2ì°¨ ì§€í•„í‰ê°€", "ratio": 30, "score": 0, "memo": ""}\n    ],\n    "finalFeedback": ""\n  }\n]`;
        const textArea = document.createElement("textarea"); textArea.value = promptText; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select();
        try { document.execCommand('copy'); 
            const originalText = btnElement.innerHTML;
            btnElement.innerHTML = "âœ… ë³µì‚¬ ì™„ë£Œ!";
            setTimeout(() => { btnElement.innerHTML = originalText; }, 2000);
        } catch (err) { showToast("ë³µì‚¬ ì‹¤íŒ¨."); } finally { document.body.removeChild(textArea); }
    }

    function copyAllData(btnElement) {
        const allData = {};
        const semesters = ['grade_1_1', 'grade_1_2', 'grade_2_1', 'grade_2_2', 'grade_3_1', 'grade_3_2'];
        
        let count = 0;
        semesters.forEach(sem => {
            const data = localStorage.getItem(sem);
            if (data) {
                try {
                    allData[sem] = JSON.parse(data);
                    count++;
                } catch (e) {
                    console.warn(`Failed to parse data for ${sem}`);
                }
            }
        });

        if (count === 0) {
            showToast("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const jsonString = JSON.stringify(allData, null, 2);
        
        const textArea = document.createElement("textarea"); textArea.value = jsonString; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select();
        try { document.execCommand('copy'); 
            const originalText = btnElement.innerHTML;
            btnElement.innerHTML = "âœ… ì „ì²´ ë°ì´í„° ë³µì‚¬ë¨!";
            showToast(`ëª¨ë“  í•™ê¸°(${count}ê°œ) ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            setTimeout(() => { btnElement.innerHTML = originalText; }, 2000);
        } catch (err) { showToast("ë³µì‚¬ ì‹¤íŒ¨."); } finally { document.body.removeChild(textArea); }
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(message) {
        const toast = document.createElement('div'); toast.className = 'toast-message'; toast.innerText = message; document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 2000);
    }

    function renderChart() {
        const ctx = document.getElementById('gradeChart').getContext('2d');
        if (myChart) myChart.destroy();
        const labels = subjects.map(s => { 
            const t = calculateTotal(s); 
            const g = getGrade(t, s.subject); 
            return g ? `${s.subject}(${g})` : s.subject; 
        });
        
        const data = subjects.map(s => truncateScore(calculateTotal(s))); 
        const sum = data.reduce((a, b) => a + b, 0);
        const avg = (sum / data.length) || 0;
        const displayAvg = truncateScore(avg);
        
        document.getElementById('avgTotal').innerText = `${displayAvg}ì `;
        document.getElementById('avgExam1').innerText = `${calculateExamAvg("1ì°¨")}ì `;
        document.getElementById('avgExam2').innerText = `${calculateExamAvg("2ì°¨")}ì `;
        
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì ìˆ˜', data: data,
                    backgroundColor: data.map((score, idx) => {
                        return getBarColor(score, subjects[idx].subject);
                    }),
                    borderRadius: 5, borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, min: 50, max: 100, grid: { borderDash: [2, 4] }, ticks: { stepSize: 10 } }, x: { grid: { display: false }, ticks: { font: { size: 11, weight: 'bold' } } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.raw + 'ì ' } } } }
        });
    }

    function updateChartData() {
        if (!myChart) { renderChart(); return; }
        const newData = subjects.map(s => truncateScore(calculateTotal(s))); 
        const newLabels = subjects.map(s => { 
            const t = calculateTotal(s); 
            const g = getGrade(t, s.subject);
            return g ? `${s.subject}(${g})` : s.subject; 
        });
        
        myChart.data.datasets[0].data = newData;
        myChart.data.datasets[0].backgroundColor = newData.map((score, idx) => {
            return getBarColor(score, subjects[idx].subject);
        });
        myChart.data.labels = newLabels;
        const sum = newData.reduce((a, b) => a + b, 0);
        const avg = (sum / newData.length) || 0;
        const displayAvg = truncateScore(avg);
        
        document.getElementById('avgTotal').innerText = `${displayAvg}ì `;
        document.getElementById('avgExam1').innerText = `${calculateExamAvg("1ì°¨")}ì `;
        document.getElementById('avgExam2').innerText = `${calculateExamAvg("2ì°¨")}ì `;
        
        myChart.update();
    }
</script>
</body>
</html>
